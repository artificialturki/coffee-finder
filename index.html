<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Coffee Finder Pro â˜• â€” Worldwide cafÃ©s (OSM)</title>
<meta name="description" content="Find cafÃ©s anywhere in the world. OpenStreetMap-based, fast, accurate, zero API keys." />
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>â˜•</text></svg>">

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
<!-- Leaflet -->
<link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet">
<!-- MarkerCluster -->
<link href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" rel="stylesheet">
<link href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" rel="stylesheet">
<!-- Opening_hours parser -->
<script defer src="https://cdn.jsdelivr.net/npm/opening_hours@3.10.1/opening_hours.min.js"></script>

<style>
  :root{
    --bg:#f7f5f2; --panel:#ffffff; --ink:#2a211c; --muted:#7a6e67;
    --brand:#c86b40; --chip:#efe8e2;
  }
  html,body{height:100%}
  body{background:linear-gradient(135deg,#faf9f8,#f3efe9); color:var(--ink)}
  header{
    background:radial-gradient(1200px 400px at 10% -10%, #4a3a36 0, #332826 60%, #2b2220 100%);
    color:#fff; padding:38px 0 22px; box-shadow:0 10px 30px rgba(0,0,0,.15)
  }
  .brand{font-weight:800; font-size:2rem; letter-spacing:.3px}
  .tag{opacity:.85}
  .search-card{
    background:var(--panel); border-radius:16px; margin-top:-22px; padding:16px 16px 10px;
    box-shadow:0 14px 30px rgba(0,0,0,.10)
  }
  .btn-brand{background:linear-gradient(135deg,var(--brand),#e36a44); border:0}
  .btn-brand:hover{filter:brightness(1.02)}
  #map{height:62vh; border-radius:14px; box-shadow:0 10px 24px rgba(0,0,0,.12)}
  .results{max-height:62vh; overflow:auto}
  .card-cafe{border:0; border-radius:14px; box-shadow:0 8px 20px rgba(0,0,0,.06)}
  .card-cafe:hover{transform:translateY(-2px); box-shadow:0 12px 26px rgba(0,0,0,.10)}
  .cmeta{font-size:.9rem; color:var(--muted)}
  .loader{display:none; text-align:center; padding:16px}
  .pill{border-radius:999px; background:var(--chip); padding:.25rem .6rem; font-size:.8rem}
  .country-select{min-width:150px}
  .suggest{position:absolute; inset:auto 0 0 0; top:100%; z-index:20; background:var(--panel);
           border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.15); overflow:hidden; display:none}
  .suggest a{display:flex; gap:.5rem; align-items:center; padding:.55rem .8rem; color:var(--ink); text-decoration:none}
  .suggest a:hover{background:#f6f3ef}
  .leaflet-popup-content{margin:.4rem .6rem}
  .cof-ic{color:#7b4e3a; font-size:18px}
  .badgish{background:#f3ede8;border-radius:8px;padding:.22rem .5rem;font-size:.8rem}
  .floating-search{position:absolute; z-index:999; right:14px; top:14px}
  .kpi{font-size:.92rem; color:var(--muted)}
  footer{padding:22px 0; color:#fff; background:#2b2220; margin-top:26px}
  .pointer{cursor:pointer}

  /* Rating Stars */
  .stars{color:#ffb400}
  .stars .fa-star,.stars .fa-star-half-stroke{margin-right:2px}
  .rate-group .fa-star{cursor:pointer; color:#d4d4d4}
  .rate-group .fa-star.hovered{color:#ffb400}
</style>
</head>
<body>

<header>
  <div class="container">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
      <div class="brand"><i class="fa-solid fa-mug-saucer me-2"></i>Coffee Finder Pro</div>
      <div class="tag">OpenStreetMap â€¢ Overpass â€¢ Zero-key â€¢ Fast â€¢ With Smart Ratings</div>
    </div>
  </div>
</header>

<main class="container">
  <!-- Search+Filters -->
  <section class="search-card">
    <div class="row g-2 align-items-stretch">
      <div class="col-12 col-xl-5 position-relative">
        <div class="input-group">
          <span class="input-group-text bg-white"><i class="fa-solid fa-magnifying-glass"></i></span>
          <input id="q" class="form-control" placeholder="City, area or address (e.g., Riyadh, Saudi Arabia)">
          <button id="btnSearch" class="btn btn-brand text-white px-4"><i class="fa-solid fa-search me-1"></i>Search</button>
        </div>
        <div id="suggestions" class="suggest rounded-3"></div>
      </div>

      <div class="col-6 col-xl-3">
        <div class="input-group">
          <span class="input-group-text bg-white"><i class="fa-solid fa-globe"></i></span>
          <select id="country" class="form-select country-select"></select>
        </div>
      </div>

      <div class="col-6 col-xl-2">
        <div class="input-group">
          <span class="input-group-text bg-white"><i class="fa-solid fa-ruler"></i></span>
          <select id="radius" class="form-select">
            <option value="2000">2 km</option>
            <option value="4000" selected>4 km</option>
            <option value="6000">6 km</option>
            <option value="8000">8 km</option>
            <option value="10000">10 km</option>
          </select>
        </div>
      </div>

      <div class="col-12 col-xl-2">
        <div class="row g-2">
          <div class="col-6 d-grid"><button id="btnLocate" class="btn btn-outline-secondary"><i class="fa-solid fa-location-crosshairs me-1"></i>Locate me</button></div>
          <div class="col-6 d-grid"><button id="btnSearchHere" class="btn btn-outline-primary" disabled><i class="fa-solid fa-arrows-to-circle me-1"></i>Search this area</button></div>
        </div>
      </div>
    </div>

    <div class="mt-2 d-flex gap-2 flex-wrap align-items-center">
      <label class="badgish"><input id="fOpen" type="checkbox" class="form-check-input me-1">Open now</label>
      <label class="badgish"><input id="fWifi" type="checkbox" class="form-check-input me-1">Wi-Fi</label>
      <label class="badgish"><input id="fOutdoor" type="checkbox" class="form-check-input me-1">Outdoor seating</label>
      <div class="kpi ms-auto"><span id="kpiTxt">Ready</span></div>
    </div>
  </section>

  <!-- Map + Results -->
  <section class="mt-3 position-relative">
    <div class="floating-search">
      <span class="badge text-bg-light">Drag the map â€” button will enable</span>
    </div>
    <div class="row g-3">
      <div class="col-lg-8"><div id="map"></div></div>
      <div class="col-lg-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="h5 m-0"><i class="fa-solid fa-list"></i> Results</div>
          <select id="sort" class="form-select form-select-sm w-auto">
            <option value="distance">by distance</option>
            <option value="name">by name</option>
            <option value="hours">open first</option>
            <option value="rating">by rating</option>
          </select>
        </div>
        <div class="loader" id="loader"><i class="fa-solid fa-spinner fa-spin me-2"></i>Searching cafÃ©sâ€¦</div>
        <div id="results" class="results"></div>
        <div id="nores" class="text-center text-muted d-none py-4">
          <i class="fa-regular fa-face-frown-open fa-2x mb-2"></i>
          <div>No cafÃ©s found. Zoom out or try another area.</div>
        </div>
      </div>
    </div>
  </section>
</main>

<footer>
  <div class="container small text-center">
    Â© <span id="yr"></span> Coffee Finder Pro â€” Tiles Â© OSM contributors â€¢ Data: Overpass/OSM/Photon â€¢ Built for speed.
  </div>
</footer>

<!-- JS: Bootstrap bundle, Leaflet & cluster -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
(() => {
  // ------------ Countries (full ISO-3166-1 alpha-2) ------------
  const ISO_COUNTRIES = [
    ["","ðŸŒ Global"],
    ["af","Afghanistan"],["ax","Ã…land Islands"],["al","Albania"],["dz","Algeria"],["as","American Samoa"],["ad","Andorra"],["ao","Angola"],
    ["ai","Anguilla"],["aq","Antarctica"],["ag","Antigua and Barbuda"],["ar","Argentina"],["am","Armenia"],["aw","Aruba"],["au","Australia"],
    ["at","Austria"],["az","Azerbaijan"],["bs","Bahamas"],["bh","Bahrain"],["bd","Bangladesh"],["bb","Barbados"],["by","Belarus"],
    ["be","Belgium"],["bz","Belize"],["bj","Benin"],["bm","Bermuda"],["bt","Bhutan"],["bo","Bolivia"],["bq","Bonaire, Sint Eustatius and Saba"],
    ["ba","Bosnia and Herzegovina"],["bw","Botswana"],["bv","Bouvet Island"],["br","Brazil"],["io","British Indian Ocean Territory"],["bn","Brunei Darussalam"],
    ["bg","Bulgaria"],["bf","Burkina Faso"],["bi","Burundi"],["cv","Cabo Verde"],["kh","Cambodia"],["cm","Cameroon"],["ca","Canada"],["ky","Cayman Islands"],
    ["cf","Central African Republic"],["td","Chad"],["cl","Chile"],["cn","China"],["cx","Christmas Island"],["cc","Cocos (Keeling) Islands"],
    ["co","Colombia"],["km","Comoros"],["cg","Congo"],["cd","Congo (DRC)"],["ck","Cook Islands"],["cr","Costa Rica"],["ci","CÃ´te dâ€™Ivoire"],
    ["hr","Croatia"],["cu","Cuba"],["cw","CuraÃ§ao"],["cy","Cyprus"],["cz","Czechia"],["dk","Denmark"],["dj","Djibouti"],["dm","Dominica"],
    ["do","Dominican Republic"],["ec","Ecuador"],["eg","Egypt"],["sv","El Salvador"],["gq","Equatorial Guinea"],["er","Eritrea"],["ee","Estonia"],
    ["sz","Eswatini"],["et","Ethiopia"],["fk","Falkland Islands"],["fo","Faroe Islands"],["fj","Fiji"],["fi","Finland"],["fr","France"],["gf","French Guiana"],
    ["pf","French Polynesia"],["tf","French Southern Territories"],["ga","Gabon"],["gm","Gambia"],["ge","Georgia"],["de","Germany"],["gh","Ghana"],
    ["gi","Gibraltar"],["gr","Greece"],["gl","Greenland"],["gd","Grenada"],["gp","Guadeloupe"],["gu","Guam"],["gt","Guatemala"],["gg","Guernsey"],
    ["gn","Guinea"],["gw","Guinea-Bissau"],["gy","Guyana"],["ht","Haiti"],["hm","Heard Island and McDonald Islands"],["va","Holy See"],
    ["hn","Honduras"],["hk","Hong Kong"],["hu","Hungary"],["is","Iceland"],["in","India"],["id","Indonesia"],["ir","Iran"],["iq","Iraq"],["ie","Ireland"],
    ["im","Isle of Man"],["il","Israel"],["it","Italy"],["jm","Jamaica"],["jp","Japan"],["je","Jersey"],["jo","Jordan"],["kz","Kazakhstan"],
    ["ke","Kenya"],["ki","Kiribati"],["kp","Korea (North)"],["kr","Korea (South)"],["kw","Kuwait"],["kg","Kyrgyzstan"],["la","Lao PDR"],
    ["lv","Latvia"],["lb","Lebanon"],["ls","Lesotho"],["lr","Liberia"],["ly","Libya"],["li","Liechtenstein"],["lt","Lithuania"],["lu","Luxembourg"],
    ["mo","Macao"],["mg","Madagascar"],["mw","Malawi"],["my","Malaysia"],["mv","Maldives"],["ml","Mali"],["mt","Malta"],["mh","Marshall Islands"],
    ["mq","Martinique"],["mr","Mauritania"],["mu","Mauritius"],["yt","Mayotte"],["mx","Mexico"],["fm","Micronesia"],["md","Moldova"],["mc","Monaco"],
    ["mn","Mongolia"],["me","Montenegro"],["ms","Montserrat"],["ma","Morocco"],["mz","Mozambique"],["mm","Myanmar"],["na","Namibia"],["nr","Nauru"],
    ["np","Nepal"],["nl","Netherlands"],["nc","New Caledonia"],["nz","New Zealand"],["ni","Nicaragua"],["ne","Niger"],["ng","Nigeria"],["nu","Niue"],
    ["nf","Norfolk Island"],["mk","North Macedonia"],["mp","Northern Mariana Islands"],["no","Norway"],["om","Oman"],["pk","Pakistan"],["pw","Palau"],
    ["ps","Palestine, State of"],["pa","Panama"],["pg","Papua New Guinea"],["py","Paraguay"],["pe","Peru"],["ph","Philippines"],["pn","Pitcairn"],
    ["pl","Poland"],["pt","Portugal"],["pr","Puerto Rico"],["qa","Qatar"],["re","RÃ©union"],["ro","Romania"],["ru","Russian Federation"],["rw","Rwanda"],
    ["bl","Saint BarthÃ©lemy"],["sh","Saint Helena, Ascension and Tristan da Cunha"],["kn","Saint Kitts and Nevis"],["lc","Saint Lucia"],
    ["mf","Saint Martin"],["pm","Saint Pierre and Miquelon"],["vc","Saint Vincent and the Grenadines"],["ws","Samoa"],["sm","San Marino"],
    ["st","Sao Tome and Principe"],["sa","Saudi Arabia"],["sn","Senegal"],["rs","Serbia"],["sc","Seychelles"],["sl","Sierra Leone"],["sg","Singapore"],
    ["sx","Sint Maarten"],["sk","Slovakia"],["si","Slovenia"],["sb","Solomon Islands"],["so","Somalia"],["za","South Africa"],["gs","South Georgia & Sandwich Is."],
    ["ss","South Sudan"],["es","Spain"],["lk","Sri Lanka"],["sd","Sudan"],["sr","Suriname"],["sj","Svalbard and Jan Mayen"],["se","Sweden"],
    ["ch","Switzerland"],["sy","Syrian Arab Republic"],["tw","Taiwan"],["tj","Tajikistan"],["tz","Tanzania"],["th","Thailand"],["tl","Timor-Leste"],
    ["tg","Togo"],["tk","Tokelau"],["to","Tonga"],["tt","Trinidad and Tobago"],["tn","Tunisia"],["tr","TÃ¼rkiye"],["tm","Turkmenistan"],["tc","Turks and Caicos Islands"],
    ["tv","Tuvalu"],["ug","Uganda"],["ua","Ukraine"],["ae","United Arab Emirates"],["gb","United Kingdom"],["us","United States of America"],
    ["um","US Minor Outlying Islands"],["uy","Uruguay"],["uz","Uzbekistan"],["vu","Vanuatu"],["ve","Venezuela"],["vn","Viet Nam"],["vg","Virgin Islands (UK)"],
    ["vi","Virgin Islands (US)"],["wf","Wallis and Futuna"],["eh","Western Sahara"],["ye","Yemen"],["zm","Zambia"],["zw","Zimbabwe"]
  ];

  // ------------ Map init ------------
  const map = L.map('map', { zoomControl:false }).setView([20, 0], 3);
  L.control.zoom({ position:'topright' }).addTo(map);
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { maxZoom: 19, attribution: '&copy; OpenStreetMap' }).addTo(map);
  const cluster = L.markerClusterGroup({ showCoverageOnHover:false, maxClusterRadius:50 });
  map.addLayer(cluster);

  // ------------ State ------------
  let countryBias = '';     // 2-letter code
  let centerBias = null;    // {lat,lon} for suggestions
  let currentOrigin = null;
  let cafes = [];           // results
  let markers = [];
  let mapMovedSinceSearch = false;

  const els = {
    q:         document.getElementById('q'),
    suggestions: document.getElementById('suggestions'),
    country:   document.getElementById('country'),
    radius:    document.getElementById('radius'),
    btnSearch: document.getElementById('btnSearch'),
    btnLocate: document.getElementById('btnLocate'),
    btnHere:   document.getElementById('btnSearchHere'),
    sort:      document.getElementById('sort'),
    fOpen:     document.getElementById('fOpen'),
    fWifi:     document.getElementById('fWifi'),
    fOutdoor:  document.getElementById('fOutdoor'),
    loader:    document.getElementById('loader'),
    results:   document.getElementById('results'),
    nores:     document.getElementById('nores'),
    kpi:       document.getElementById('kpiTxt')
  };

  // Populate countries
  (function fillCountries(){
    els.country.innerHTML = ISO_COUNTRIES.map(([c,n]) => `<option value="${c}">${n}</option>`).join('');
    els.country.value = '';
  })();

  // ------------ Utils ------------
  const deg2rad = d => d*Math.PI/180;
  function haversine(lat1,lon1,lat2,lon2){
    const R=6371, dLat=deg2rad(lat2-lat1), dLon=deg2rad(lon2-lon1);
    const a=Math.sin(dLat/2)**2 + Math.cos(deg2rad(lat1))*Math.cos(deg2rad(lat2))*Math.sin(dLon/2)**2;
    return R*2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }
  function show(el){ el.classList.remove('d-none'); }
  function hide(el){ el.classList.add('d-none'); }
  function startLoading(msg='Searching cafÃ©sâ€¦'){
    els.loader.style.display='block'; els.loader.textContent=''; els.loader.insertAdjacentHTML('afterbegin', '<i class="fa-solid fa-spinner fa-spin me-2"></i>'+msg);
    els.results.innerHTML=''; hide(els.nores);
  }
  function stopLoading(){ els.loader.style.display='none'; }
  const escapeHtml = s => (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m]));
  function safeUrl(u){ try{ const x=new URL(u, location.href); return x.href; }catch(_){ return '#'; } }
  function directionsUrl(lat,lon){ const isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent); return isIOS ? `http://maps.apple.com/?daddr=${lat},${lon}` : `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}`; }
  const fmtK = n => n.toLocaleString();

  // Normalize strings (autocorrect)
  const norm = s => (s||'').toLowerCase().normalize('NFD').replace(/\p{Diacritic}/gu,'').trim();
  function dice(a,b){ // SÃ¸rensenâ€“Dice coefficient
    a=norm(a); b=norm(b);
    if (a===b) return 1;
    if (a.length<2 || b.length<2) return 0;
    const bigrams = s => Array.from({length:s.length-1},(_,i)=>s.slice(i,i+2));
    const a2=bigrams(a), b2=bigrams(b);
    const set=new Map(); a2.forEach(x=>set.set(x,(set.get(x)||0)+1));
    let inter=0; b2.forEach(x=>{const v=set.get(x)||0; if(v){ inter++; set.set(x,v-1);} });
    return (2*inter)/(a2.length+b2.length);
  }

  // ------------ Auto-detect country (best effort) ------------
  (async () => {
    try{
      const r = await fetch('https://ipapi.co/json/');
      if (!r.ok) throw 0;
      const j = await r.json();
      if (j && j.country_code) {
        countryBias = (j.country_code||'').toLowerCase();
        const idx = ISO_COUNTRIES.findIndex(x=>x[0]===countryBias);
        if (idx>=0) els.country.value = countryBias;
        if (j.latitude && j.longitude) centerBias = { lat:j.latitude, lon:j.longitude };
      }
    }catch(_){}
  })();

  // ------------ Suggestions (Photon) ------------
  let sugTimer = null;
  els.q.addEventListener('input', () => {
    const val = els.q.value.trim();
    if (val.length < 2) { els.suggestions.style.display='none'; els.suggestions.innerHTML=''; return; }
    clearTimeout(sugTimer); sugTimer = setTimeout(loadSuggestions, 200);
  });

  async function loadSuggestions(){
    const val = els.q.value.trim(); if (!val) return;
    const url = new URL('https://photon.komoot.io/api/');
    url.searchParams.set('q', val);
    url.searchParams.set('limit','8');
    url.searchParams.set('lang','en');
    url.searchParams.set('layer','city,town,village,locality'); // city-ish layers only
    if (countryBias) url.searchParams.set('osm_tag', `countrycode:${countryBias}`); // mild hint
    if (centerBias){ url.searchParams.set('lat', centerBias.lat); url.searchParams.set('lon', centerBias.lon); }
    try{
      const r = await fetch(url); const j = await r.json();
      const items = (j.features||[]).map(f=>{
        const p=f.properties||{}, line=[p.name,p.city,p.state,p.country].filter(Boolean).join(', ');
        return { label: line||p.name, lat:f.geometry.coordinates[1], lon:f.geometry.coordinates[0] };
      }).slice(0,8);
      if (!items.length){ els.suggestions.style.display='none'; els.suggestions.innerHTML=''; return; }
      els.suggestions.innerHTML = items.map(i => `
        <a class="pointer" data-lat="${i.lat}" data-lon="${i.lon}">
          <i class="fa-solid fa-location-dot text-danger"></i>
          <span>${escapeHtml(i.label)}</span>
        </a>`).join('');
      els.suggestions.style.display='block';
    }catch(_){ els.suggestions.style.display='none'; els.suggestions.innerHTML=''; }
  }
  els.suggestions.addEventListener('click', e=>{
    const a=e.target.closest('a[data-lat]'); if (!a) return;
    els.suggestions.style.display='none'; els.suggestions.innerHTML='';
    const lat=parseFloat(a.dataset.lat), lon=parseFloat(a.dataset.lon);
    toast(`Using: ${els.q.value}`);
    doSearchAt(lat,lon);
  });
  document.addEventListener('click', e=>{
    if (!els.suggestions.contains(e.target) && e.target!==els.q) els.suggestions.style.display='none';
  });

  // ------------ Geocode with autocorrect + strong country bias ------------
  els.btnSearch.addEventListener('click', ()=> tryAutocorrectThenGeocode());
  els.q.addEventListener('keydown', e=>{ if (e.key==='Enter'){ e.preventDefault(); tryAutocorrectThenGeocode(); } });
  els.country.addEventListener('change', ()=> countryBias = els.country.value||'');

  async function tryAutocorrectThenGeocode(){
    const typed = els.q.value.trim(); if (!typed) return els.q.focus();
    // 1) Try Photon quick guess
    const guess = await topPhotonGuess(typed);
    if (guess && dice(typed, guess.label) >= 0.62) {
      els.suggestions.style.display='none'; els.suggestions.innerHTML='';
      toast(`Using: ${guess.label}`);
      return doSearchAt(guess.lat, guess.lon);
    }
    // 2) Fallback to Nominatim
    return geocodeText(typed);
  }

  async function topPhotonGuess(text){
    const url = new URL('https://photon.komoot.io/api/');
    url.searchParams.set('q', text);
    url.searchParams.set('limit','1');
    url.searchParams.set('layer','city,town,village,locality');
    url.searchParams.set('lang','en');
    if (countryBias) url.searchParams.set('osm_tag', `countrycode:${countryBias}`);
    if (centerBias){ url.searchParams.set('lat', centerBias.lat); url.searchParams.set('lon', centerBias.lon); }
    try{
      const r=await fetch(url); const j=await r.json();
      const f=(j.features||[])[0]; if(!f) return null;
      const p=f.properties||{}, label=[p.name,p.city,p.state,p.country].filter(Boolean).join(', ');
      return { label: label||p.name, lat:f.geometry.coordinates[1], lon:f.geometry.coordinates[0] };
    }catch(_){ return null; }
  }

  async function geocodeText(text){
    const url = new URL('https://nominatim.openstreetmap.org/search');
    url.searchParams.set('format','json'); url.searchParams.set('addressdetails','1');
    url.searchParams.set('limit','5'); url.searchParams.set('q', text);
    if (countryBias) url.searchParams.set('countrycodes', countryBias);
    try{
      startLoading('Finding placeâ€¦');
      const r=await fetch(url.toString(), { headers:{'Accept-Language':'en'} }); const j=await r.json();
      if (!j.length){ stopLoading(); showNoResults('No matching location. Try adding the country.'); return; }
      const loc=j[0]; const lat=parseFloat(loc.lat), lon=parseFloat(loc.lon);
      toast(`Using: ${loc.display_name.split(',').slice(0,3).join(', ')}`);
      doSearchAt(lat, lon);
    }catch(_){ stopLoading(); showNoResults('Search failed. Please try again.'); }
  }

  // ------------ Map move detection â†’ enable â€œSearch this areaâ€ ------------
  map.on('moveend', () => { mapMovedSinceSearch = true; els.btnHere.disabled=false; });
  els.btnHere.addEventListener('click', ()=>{
    const c = map.getCenter(); doSearchAt(c.lat, c.lng, true);
  });

  // ------------ Locate me ------------
  els.btnLocate.addEventListener('click', ()=>{
    if (!navigator.geolocation) return alert('Geolocation is not supported.');
    startLoading('Getting your locationâ€¦');
    navigator.geolocation.getCurrentPosition(pos=>{
      const {latitude:lat, longitude:lon} = pos.coords;
      centerBias = {lat,lon}; toast('Using your current location');
      doSearchAt(lat,lon, false, 14);
    }, _=>{ stopLoading(); alert('Could not get your location. Try searching by city.'); }, { enableHighAccuracy:true, timeout:10000 });
  });

  function doSearchAt(lat,lon, fromMapMove=false, zoom=13){
    currentOrigin = {lat,lon};
    map.setView([lat,lon], Math.max(zoom, map.getZoom()));
    mapMovedSinceSearch = false; els.btnHere.disabled = true;
    findCafes(lat,lon, parseInt(els.radius.value,10));
  }

  // ------------ Overpass failover ------------
  const OVERPASS = [
    'https://overpass-api.de/api/interpreter',
    'https://overpass.kumi.systems/api/interpreter',
    'https://z.overpass-api.de/api/interpreter'
  ];
  async function overpassFetch(body){
    for (const ep of OVERPASS){
      try{
        const ctrl = new AbortController(); const t = setTimeout(()=>ctrl.abort(), 18000);
        const r = await fetch(ep, { method:'POST', body, signal:ctrl.signal });
        clearTimeout(t);
        if (r.ok) return await r.json();
      }catch(_){ /* try next */ }
    }
    throw new Error('All Overpass endpoints failed');
  }

  // ------------ Query & render ------------
  async function findCafes(lat,lon,radius){
    startLoading('Searching cafÃ©sâ€¦');
    const q=`
      [out:json][timeout:25];
      (
        node["amenity"="cafe"](around:${radius},${lat},${lon});
        way["amenity"="cafe"](around:${radius},${lat},${lon});
        node["shop"="coffee"](around:${radius},${lat},${lon});
      );
      out center tags;
    `;
    let data;
    try { data = await overpassFetch(q); }
    catch(_) { stopLoading(); showNoResults('Search failed (Overpass). Please try again.'); return; }

    const elsData = data.elements||[];
    cafes = elsData.map(e=>{
      const c = e.type==='way' ? e.center : { lat:e.lat, lon:e.lon };
      const tags = e.tags||{};
      const distance = currentOrigin ? haversine(currentOrigin.lat,currentOrigin.lon,c.lat,c.lon) : null;
      const smart = smartScore(tags, distance);
      const user  = getUserRating(e.id);
      const combined = user ? (0.7*smart + 0.3*user) : smart;
      return {
        id:e.id, lat:c.lat, lon:c.lon, tags,
        name: tags.name || tags.brand || 'Unnamed cafÃ©',
        distance, opening: tags.opening_hours || null,
        smartRating: smart, userRating: user, combinedRating: clamp(combined,0,5)
      };
    });
    applyFiltersAndRender();
    stopLoading();
  }

  // ------------ Smart rating (0..5) ------------
  function clamp(n,min,max){ return Math.max(min, Math.min(max,n)); }
  function smartScore(tags, distanceKm){
    let score = 2.6; // base
    if (tags.opening_hours) score += 0.7;
    if (tags.internet_access === 'yes') score += 0.6;
    if (tags.outdoor_seating === 'yes') score += 0.5;
    if (tags.website || tags['contact:website']) score += 0.4;
    if (tags.phone || tags['contact:phone']) score += 0.3;
    if (tags.wheelchair === 'yes') score += 0.2;
    if (tags.brand) score += 0.2;
    if (tags.cuisine) score += 0.1;

    if (typeof distanceKm === 'number'){
      // penalize far results gently
      if (distanceKm > 8) score -= 0.8;
      else if (distanceKm > 5) score -= 0.6;
      else if (distanceKm > 3) score -= 0.3;
    }
    return clamp(score, 0, 5);
  }

  // user rating storage
  function getUserRating(id){ const k=`cfp_rating_${id}`; const v=localStorage.getItem(k); return v?parseFloat(v):null; }
  function setUserRating(id,val){ localStorage.setItem(`cfp_rating_${id}`, String(val)); }

  // ------------ Filters/sort ------------
  els.fOpen .addEventListener('change', applyFiltersAndRender);
  els.fWifi .addEventListener('change', applyFiltersAndRender);
  els.fOutdoor.addEventListener('change', applyFiltersAndRender);
  els.sort  .addEventListener('change', applyFiltersAndRender);

  function isOpenNow(cafe){
    if (!cafe.opening) return false;
    if (cafe.opening.includes('24/7')) return true;
    try{
      if (window.opening_hours) {
        const oh = new opening_hours(cafe.opening);
        return oh.getState(new Date());
      }
    }catch(_){}
    const m = /(\d{1,2}):(\d{2})\s*-\s*(\d{1,2}):(\d{2})/.exec(cafe.opening);
    if (m){
      const now=new Date(); const mins=now.getHours()*60+now.getMinutes();
      const open=parseInt(m[1])*60+parseInt(m[2]); const close=parseInt(m[3])*60+parseInt(m[4]);
      if (close>open) return mins>=open && mins<=close;
      return (mins>=open) || (mins<=close);
    }
    return false;
  }

  function applyFiltersAndRender(){
    let list = cafes.slice();

    const needOpen   = els.fOpen.checked;
    const needWifi   = els.fWifi.checked;
    const needOutdoor= els.fOutdoor.checked;

    if (needOpen)   list = list.filter(isOpenNow);
    if (needWifi)   list = list.filter(c => (c.tags.internet_access === 'yes'));
    if (needOutdoor)list = list.filter(c => (c.tags.outdoor_seating === 'yes'));

    const mode = els.sort.value;
    if (mode==='name') list.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
    else if (mode==='hours') list.sort((a,b)=> ((b.opening?1:0) - (a.opening?1:0)));
    else if (mode==='rating') list.sort((a,b)=> (b.combinedRating - a.combinedRating));
    else list.sort((a,b)=> (a.distance??1e9)-(b.distance??1e9));

    render(list);
  }

  // ------------ Rendering ------------
  function renderStars(score){
    // full/half/empty stars for score 0..5
    let html='', s=clamp(score,0,5), full=Math.floor(s), half=(s-full)>=0.25 && (s-full)<0.75;
    for(let i=0;i<full;i++) html+='<i class="fa-solid fa-star"></i>';
    if(half) html+='<i class="fa-solid fa-star-half-stroke"></i>';
    for(let i=(half?full+1:full); i<5; i++) html+='<i class="fa-regular fa-star"></i>';
    return html;
  }

  function render(list){
    els.kpi.textContent = list.length ? `Showing ${fmtK(list.length)} cafÃ©s` : 'No cafÃ©s';
    cluster.clearLayers(); markers.length=0;

    if (!list.length){ els.results.innerHTML=''; show(els.nores); return; }
    hide(els.nores);

    const icon = L.divIcon({ className:'', html:'<i class="fa-solid fa-mug-hot cof-ic"></i>', iconSize:[24,24], iconAnchor:[12,12] });
    list.forEach((c, i)=>{
      const m=L.marker([c.lat,c.lon],{icon}).bindPopup(popupHtml(c));
      m.on('mouseover',()=>m.openPopup());
      cluster.addLayer(m); markers.push(m);
    });

    els.results.innerHTML = list.map((c,i)=> cardHtml(c,i)).join('');
    // hover sync & rating clicks
    els.results.querySelectorAll('[data-idx]').forEach(el=>{
      const i=+el.dataset.idx;
      el.addEventListener('mouseenter', ()=> markers[i].openPopup());
      el.addEventListener('click', e=>{
        if (!e.target.closest('.rate-group')){ map.setView(markers[i].getLatLng(), 16); markers[i].openPopup(); }
      });
    });
    els.results.querySelectorAll('.rate-group .fa-star').forEach(st=>{
      st.addEventListener('mouseenter', e=> e.target.parentElement.querySelectorAll('.fa-star').forEach(x=>x.classList.toggle('hovered', x.dataset.v<=e.target.dataset.v)));
      st.addEventListener('mouseleave', e=> e.target.parentElement.querySelectorAll('.fa-star').forEach(x=>x.classList.remove('hovered')));
      st.addEventListener('click', e=>{
        const idx=parseInt(e.target.closest('.rate-group').dataset.idx,10);
        const val=parseInt(e.target.dataset.v,10);
        setUserRating(list[idx].id, val);
        // update ratings live
        list[idx].userRating = val;
        list[idx].combinedRating = clamp(0.7*list[idx].smartRating + 0.3*val, 0, 5);
        applyFiltersAndRender();
      });
    });
  }

  function popupHtml(c){
    const web = c.tags.website || c.tags['contact:website'];
    const phone = c.tags.phone || c.tags['contact:phone'];
    const wifi = c.tags.internet_access === 'yes' ? `<span class="pill"><i class="fa-solid fa-wifi"></i> Wi-Fi</span>` : '';
    const outdoor = c.tags.outdoor_seating === 'yes' ? `<span class="pill"><i class="fa-solid fa-umbrella-beach"></i> outdoor</span>` : '';
    const openS = c.opening ? `<div class="small"><i class="fa-regular fa-clock me-1"></i>${escapeHtml(c.opening)}</div>` : '';
    const distS = c.distance!=null ? `<div class="small text-muted">${c.distance.toFixed(1)} km away</div>` : '';
    const addr = [c.tags['addr:street'], c.tags['addr:city']].filter(Boolean).join(', ');
    const addrS = addr ? `<div class="small"><i class="fa-solid fa-location-dot me-1"></i>${escapeHtml(addr)}</div>` : '';

    return `
      <div><strong>${escapeHtml(c.name)}</strong></div>
      <div class="stars my-1">${renderStars(c.combinedRating)} <span class="text-muted small">(${c.combinedRating.toFixed(1)})</span></div>
      ${distS}${addrS}${openS}
      <div class="mt-1 d-flex gap-1 flex-wrap">${wifi}${outdoor}</div>
      <div class="mt-2 d-flex gap-1 flex-wrap">
        <a class="btn btn-sm btn-primary" target="_blank" href="${directionsUrl(c.lat,c.lon)}"><i class="fa-solid fa-turn-up me-1"></i>Directions</a>
        <a class="btn btn-sm btn-outline-secondary" target="_blank" href="https://www.openstreetmap.org/?mlat=${c.lat}&mlon=${c.lon}#map=19/${c.lat}/${c.lon}">OSM</a>
        ${web?`<a class="btn btn-sm btn-outline-secondary" target="_blank" href="${safeUrl(web)}">Website</a>`:''}
        ${phone?`<a class="btn btn-sm btn-outline-secondary" href="tel:${encodeURIComponent(phone)}">Call</a>`:''}
      </div>
    `;
  }

  function cardHtml(c, idx){
    const web = c.tags.website || c.tags['contact:website'];
    const phone = c.tags.phone || c.tags['contact:phone'];
    const addr = [c.tags['addr:street'], c.tags['addr:city']].filter(Boolean).join(', ');
    const user = c.userRating || 0;

    return `
      <div class="card card-cafe mb-2 pointer" data-idx="${idx}">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="fw-bold">${escapeHtml(c.name)}</div>
              <div class="stars">${renderStars(c.combinedRating)} <span class="text-muted small">(${c.combinedRating.toFixed(1)})</span></div>
              <div class="cmeta">${c.distance!=null?`${c.distance.toFixed(1)} km away`:''}</div>
            </div>
            <div class="text-nowrap">
              <a class="btn btn-sm btn-outline-primary" target="_blank" href="${directionsUrl(c.lat,c.lon)}" title="Directions"><i class="fa-solid fa-route"></i></a>
              <a class="btn btn-sm btn-outline-secondary" target="_blank" href="https://www.openstreetmap.org/?mlat=${c.lat}&mlon=${c.lon}#map=19/${c.lat}/${c.lon}" title="OpenStreetMap"><i class="fa-brands fa-openid"></i></a>
            </div>
          </div>
          ${addr?`<div class="mt-1 cmeta"><i class="fa-solid fa-location-dot me-1"></i>${escapeHtml(addr)}</div>`:''}
          ${c.opening?`<div class="mt-1 cmeta"><i class="fa-regular fa-clock me-1"></i>${escapeHtml(c.opening)}</div>`:''}
          <div class="mt-2 d-flex gap-2 flex-wrap">
            ${c.tags.internet_access==='yes'?'<span class="pill"><i class="fa-solid fa-wifi"></i> Wi-Fi</span>':''}
            ${c.tags.outdoor_seating==='yes'?'<span class="pill"><i class="fa-solid fa-umbrella-beach"></i> outdoor</span>':''}
          </div>
          <div class="mt-2 d-flex gap-3 flex-wrap small">
            ${web?`<a class="text-decoration-none" target="_blank" href="${safeUrl(web)}"><i class="fa-solid fa-globe me-1"></i>Website</a>`:''}
            ${phone?`<a class="text-decoration-none" href="tel:${encodeURIComponent(phone)}"><i class="fa-solid fa-phone me-1"></i>Call</a>`:''}
          </div>
          <div class="mt-2 small">Your rating:</div>
          <div class="rate-group" data-idx="${idx}">
            ${[1,2,3,4,5].map(v=>`<i class="fa-solid fa-star ${user && v<=user ? 'hovered':''}" data-v="${v}" title="${v}"></i>`).join('')}
          </div>
        </div>
      </div>`;
  }

  function showNoResults(msg){ els.results.innerHTML=`<div class="text-center text-muted py-4">${escapeHtml(msg)}</div>`; show(els.nores); }

  // Simple toast
  function toast(msg){
    const d=document.createElement('div');
    d.className='toast align-items-center text-bg-dark border-0 position-fixed bottom-0 end-0 m-3';
    d.setAttribute('role','alert'); d.innerHTML=`<div class="d-flex"><div class="toast-body">${escapeHtml(msg)}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
    document.body.appendChild(d); const t=new bootstrap.Toast(d,{delay:2200}); t.show(); d.addEventListener('hidden.bs.toast',()=>d.remove());
  }

  // Footer year
  document.getElementById('yr').textContent = new Date().getFullYear();
})();
</script>
</body>
</html>
