<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Coffee Finder Pro</title>

  <!-- Bootstrap for modern UI -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>

  <style>
    body { font-family: 'Segoe UI', sans-serif; background: #f9f9f9; }
    header { background: linear-gradient(90deg, #3c2f2f, #6d4c41); color:#fff; padding:1rem; text-align:center; }
    #map { height: 70vh; width: 100%; border-radius: 8px; }
    .results { margin-top: 1rem; }
    .card { margin-bottom: 1rem; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
    .leaflet-popup-content { font-size: 14px; }
  </style>
</head>
<body>
  <header>
    <h1>‚òï Coffee Finder Pro</h1>
    <p>Find caf√©s anywhere in the world üåç (Powered by OpenStreetMap)</p>
  </header>

  <div class="container my-3">
    <div class="input-group mb-3">
      <input type="text" id="locationInput" class="form-control" placeholder="Enter city, country (e.g. Riyadh, Saudi Arabia)">
      <button class="btn btn-dark" onclick="searchLocation()">Search</button>
    </div>

    <select id="locationChoices" class="form-select mb-3 d-none" onchange="chooseLocation(this.value)">
      <option value="">Select the correct location</option>
    </select>

    <div id="map"></div>

    <div class="results">
      <h3>Results</h3>
      <div id="list"></div>
    </div>
  </div>

  <!-- Leaflet JS -->
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>

  <script>
    const map = L.map('map').setView([20, 0], 2);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    let markers = [];

    async function searchLocation() {
      const query = document.getElementById("locationInput").value;
      if (!query) return alert("Enter a location!");

      const geoRes = await fetch(`https://nominatim.openstreetmap.org/search?format=json&addressdetails=1&limit=5&q=${encodeURIComponent(query)}`);
      const geoData = await geoRes.json();

      const choices = document.getElementById("locationChoices");
      choices.innerHTML = "<option value=''>Select the correct location</option>";

      if (geoData.length === 0) {
        choices.classList.add("d-none");
        alert("No locations found.");
        return;
      }

      geoData.forEach((loc, idx) => {
        const text = `${loc.display_name}`;
        const opt = document.createElement("option");
        opt.value = `${loc.lat},${loc.lon}`;
        opt.textContent = text;
        choices.appendChild(opt);
      });

      choices.classList.remove("d-none");
    }

    async function chooseLocation(value) {
      if (!value) return;
      const [lat, lon] = value.split(",");
      map.setView([lat, lon], 14);

      // Clear old markers
      markers.forEach(m => map.removeLayer(m));
      markers = [];

      const query = `
        [out:json];
        node["amenity"="cafe"](around:3000,${lat},${lon});
        out;
      `;
      const overRes = await fetch("https://overpass-api.de/api/interpreter", {
        method: "POST",
        body: query
      });
      const overData = await overRes.json();

      const listDiv = document.getElementById("list");
      listDiv.innerHTML = "";

      if (overData.elements.length === 0) {
        listDiv.innerHTML = "<p>No caf√©s found nearby.</p>";
        return;
      }

      overData.elements.forEach(place => {
        const name = place.tags.name || "Unnamed Caf√©";
        const marker = L.marker([place.lat, place.lon]).addTo(map)
          .bindPopup(`<b>${name}</b>`);
        markers.push(marker);

        const card = document.createElement("div");
        card.className = "card p-2";
        card.innerHTML = `
          <h5>${name}</h5>
          <p>Lat: ${place.lat}, Lon: ${place.lon}</p>
          <a href="https://www.google.com/maps/dir/?api=1&destination=${place.lat},${place.lon}" 
             target="_blank" class="btn btn-sm btn-outline-dark">üìç Get Directions</a>
        `;
        listDiv.appendChild(card);
      });
    }
  </script>
</body>
</html>
