<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Coffee Finder Pro ‚òï ‚Äî Better, Faster, Fixed</title>
<meta name="description" content="Find caf√©s anywhere in the world. Autocomplete, cluster map, ratings, zero API keys." />
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.8em' font-size='80'>‚òï</text></svg>'">

<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
<link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet">
<link href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" rel="stylesheet">
<link href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" rel="stylesheet">

<style>
  :root{
    /* slightly lighter + greener */
    --ink:#eafff6;--muted:#b8e4d5;--bg1:#0f1814;--bg2:#0b231b;
    --panel:#0f2a20cc;--line:#1f4c3c;--mint:#3be7a0;--mint2:#1dc57e;
    --cup:#7a5238;--foam:#fff;--steam:#a6f3d6;
    --radius:16px;--shadow:0 8px 24px rgba(0,0,0,.28);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{color:var(--ink);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif;background:radial-gradient(1200px 500px at 20% -10%,#1a3a30 0,var(--bg1) 55%,var(--bg2) 100%);line-height:1.6;overflow-x:hidden}
  header{position:sticky;top:0;z-index:30;background:linear-gradient(180deg,rgba(15,42,32,.95),rgba(15,42,32,.7));backdrop-filter:blur(6px);box-shadow:var(--shadow);padding:.75rem 0}
  .brand{font-weight:900;font-size:2rem;letter-spacing:.4px;display:flex;gap:.6rem;align-items:center;color:#ecfff7;text-shadow:0 2px 12px rgba(59,231,160,.35)}
  .brand i{color:#62ffd0;filter:drop-shadow(0 0 6px #2eeaa066)}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
  .chip-input{background:#0d2a20;border:1px solid var(--line);border-radius:14px;padding:.7rem .9rem;display:flex;align-items:center;gap:.7rem}
  .chip-input input{all:unset;color:var(--ink);width:460px;max-width:60vw;font-size:1.05rem}
  .btn-mint{background:linear-gradient(180deg,var(--mint),var(--mint2));color:#062016;font-weight:800;border:0;border-radius:12px;padding:.65rem 1rem;box-shadow:0 10px 24px #22d1893f;cursor:pointer;transition:.2s}
  .btn-mint:hover{filter:brightness(1.1);transform:translateY(-2px)}
  .suggest{position:absolute;top:100%;left:0;right:0;z-index:50;display:none;max-height:300px;overflow:auto}
  .suggest a{display:flex;align-items:center;gap:.55rem;padding:.65rem .8rem;color:var(--ink);text-decoration:none;background:#0f231c;border-bottom:1px solid #1a4536;transition:.2s}
  .suggest a:hover{background:#123427;padding-left:1rem}
  #map{height:62vh;border-radius:var(--radius);box-shadow:var(--shadow);position:relative}
  /* real fullscreen class */
  .map-full{position:fixed !important;inset:0 !important;width:100% !important;height:100% !important;z-index:1000;border-radius:0 !important}
  .map-float{position:absolute;left:12px;bottom:12px;z-index:1002;display:flex;flex-direction:column;gap:.6rem;pointer-events:none}
  .float-btn{pointer-events:auto;width:54px;height:54px;border-radius:50%;border:1px solid var(--line);background:#0f2a20;color:var(--ink);display:flex;align-items:center;justify-content:center;cursor:pointer;box-shadow:var(--shadow);transition:.2s}
  .float-btn:hover{background:#123628;transform:scale(1.05)}
  /* cup marker */
  .cup{position:relative;width:26px;height:18px;border-radius:4px 4px 6px 6px;background:var(--cup);border:2px solid #543a29}
  .cup:after{content:"";position:absolute;right:-8px;top:4px;width:8px;height:8px;border:2px solid #543a29;border-left:none;border-radius:0 8px 8px 0}
  .foam{position:absolute;top:-6px;left:2px;right:2px;height:6px;background:var(--foam);border-radius:6px 6px 0 0}
  .steam{position:absolute;top:-18px;left:4px;right:4px;height:14px;background:radial-gradient(circle at 30% 60%,var(--steam) 22%,transparent 50%),radial-gradient(circle at 70% 40%,var(--steam) 22%,transparent 50%);filter:blur(1px);opacity:.8;animation:steam 2.6s ease-in-out infinite}
  @keyframes steam{0%{transform:translateY(8px);opacity:.35}50%{transform:translateY(-2px);opacity:1}100%{transform:translateY(-10px);opacity:.35}}
  .results{max-height:62vh;overflow:auto;scrollbar-width:thin;scrollbar-color:#1e4a3a transparent}
  .results::-webkit-scrollbar{width:6px}.results::-webkit-scrollbar-thumb{background:#1e4a3a;border-radius:3px}
  .card-cafe{background:#0e231b;border:1px solid var(--line);border-radius:14px;transition:.3s;overflow:hidden}
  .card-cafe:hover{transform:translateY(-3px);box-shadow:0 12px 28px rgba(0,0,0,.35);border-color:var(--mint)}
  .avatar{width:52px;height:52px;border-radius:14px;background:#fff;border:1px solid #eaeaea;display:flex;align-items:center;justify-content:center;overflow:hidden;flex-shrink:0}
  .avatar .letter{font-weight:900;color:#222}.avatar img{width:100%;height:100%;object-fit:contain;padding:6px}
  .stars i{color:#ffc34d}
  .chip{background:#103c2f;border:1px solid var(--line);padding:.25rem .55rem;border-radius:999px;font-size:.85rem;display:inline-flex;align-items:center;gap:.25rem}
  .btn-route{background:linear-gradient(180deg,var(--mint),var(--mint2));color:#062016;border:0}
  .toast-container{position:fixed;bottom:20px;right:20px;z-index:2100;display:flex;flex-direction:column;gap:10px}
  .toast{background:#0f2a20;color:var(--ink);border:1px solid var(--line);padding:12px 16px;border-radius:var(--radius);box-shadow:var(--shadow);display:flex;align-items:center;gap:10px;animation:toast-in .3s ease;max-width:320px}
  @keyframes toast-in{from{transform:translateX(100%);opacity:0}to{transform:translateX(0);opacity:1}}
  .loader{display:none;text-align:center;padding:2rem}
  .coffee-loader{display:inline-block;position:relative;width:80px;height:80px}
  .coffee-loader div{display:inline-block;position:absolute;left:8px;width:16px;background:var(--mint);animation:coffee-loader 1.2s cubic-bezier(0,.5,.5,1) infinite;border-radius:20px}
  .coffee-loader div:nth-child(1){left:8px;animation-delay:-.24s}
  .coffee-loader div:nth-child(2){left:32px;animation-delay:-.12s}
  .coffee-loader div:nth-child(3){left:56px;animation-delay:0}
  @keyframes coffee-loader{0%{top:8px;height:64px}50%,100%{top:24px;height:32px}}
  .rate{display:flex;gap:2px}.rate i{cursor:pointer;transition:.2s}.rate i:hover{transform:scale(1.2)}
  @media (max-width:992px){#map{height:50vh}.results{max-height:50vh}.brand{font-size:1.7rem}}
  @media (max-width:768px){.chip-input{flex-direction:column;align-items:stretch;gap:.5rem}.chip-input input{max-width:100%;width:100%}.map-float{flex-direction:row;bottom:20px;left:50%;transform:translateX(-50%)}.float-btn{width:46px;height:46px}header .container{flex-direction:column;gap:.5rem}.brand{justify-content:center}}
  @media (max-width:576px){.panel{padding:1rem}.chip-input{padding:.6rem}.brand{font-size:1.5rem}}
</style>
</head>
<body>
<header class="py-3">
  <div class="container d-flex align-items-center justify-content-between flex-wrap">
    <div class="brand"><i class="fa-solid fa-mug-saucer"></i> Coffee Finder Pro</div>
    <div class="d-flex gap-2 flex-wrap">
      <select id="lang" class="form-select form-select-sm bg-dark text-light border-secondary">
        <option value="en" selected>English</option><option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option><option value="fr">Fran√ßais</option>
        <option value="es">Espa√±ol</option><option value="de">Deutsch</option><option value="tr">T√ºrk√ße</option>
        <option value="ur">ÿßÿ±ÿØŸà</option><option value="id">Bahasa Indonesia</option><option value="hi">‡§π‡§ø‡§Ç‡§¶‡•Ä</option>
        <option value="zh">‰∏≠Êñá</option><option value="ru">–†—É—Å—Å–∫–∏–π</option>
      </select>
      <select id="country" class="form-select form-select-sm bg-dark text-light border-secondary">
        <option value="">üåç Global</option>
      </select>
    </div>
  </div>
</header>

<main class="container my-3">
  <section class="p-3 panel">
    <div class="row g-2 align-items-stretch position-relative">
      <div class="col-lg-8 position-relative">
        <div class="chip-input">
          <i class="fa-solid fa-magnifying-glass text-success"></i>
          <input id="query" placeholder="Enter city (e.g., Riyadh, Jeddah, Boston)" aria-label="Search for a city">
          <button id="btnSearch" class="btn btn-mint"><i class="fa-solid fa-search me-1"></i>Find</button>
        </div>
        <div id="suggestions" class="suggest panel"></div>
      </div>

      <div class="col-6 col-lg-2">
        <select id="radius" class="form-select bg-dark text-light border-secondary">
          <option value="2000">2 km</option><option value="4000">4 km</option><option value="6000">6 km</option>
          <option value="8000">8 km</option><option value="10000">10 km</option><option value="20000">20 km</option>
          <option value="30000">30 km</option><option value="40000">40 km</option><option value="50000" selected>50 km</option>
        </select>
      </div>

      <div class="col-6 col-lg-2 d-flex gap-2 flex-wrap">
        <label class="chip form-check m-0"><input id="fOpen" class="form-check-input me-1" type="checkbox"><span>Open now</span></label>
        <label class="chip form-check m-0"><input id="fWifi" class="form-check-input me-1" type="checkbox"><span>Wi-Fi</span></label>
        <label class="chip form-check m-0"><input id="fOutdoor" class="form-check-input me-1" type="checkbox"><span>Outdoor</span></label>
      </div>
    </div>

    <div class="mt-2 d-flex align-items-center gap-3 flex-wrap">
      <div class="d-flex align-items-center gap-2">
        <span class="small text-secondary">Min rating</span>
        <input id="minRating" type="range" min="0" max="5" step="0.5" value="0" aria-label="Minimum rating">
        <span id="minRatingVal" class="small">0.0</span>
      </div>
      <div class="ms-auto small" id="kpi">Ready</div>
    </div>
  </section>

  <section class="position-relative mt-3">
    <div class="row g-3">
      <div class="col-lg-8 position-relative">
        <div id="map"></div>
        <div class="map-float">
          <button id="btnFullscreen" class="float-btn" title="Fullscreen" aria-label="Toggle fullscreen map"><i class="fa-solid fa-maximize"></i></button>
          <button id="btnSearchHere" class="float-btn" title="Search this area" aria-label="Search this area"><i class="fa-solid fa-bullseye"></i></button>
          <button id="btnLocate" class="float-btn" title="Locate me" aria-label="Use my current location"><i class="fa-solid fa-location-arrow"></i></button>
        </div>
      </div>

      <div class="col-lg-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="h5 m-0"><i class="fa-solid fa-list me-2"></i>Results</div>
          <select id="sort" class="form-select form-select-sm bg-dark text-light border-secondary">
            <option value="distance">by distance</option>
            <option value="name">by name</option>
            <option value="rating" selected>by rating</option>
            <option value="hours">open first</option>
          </select>
        </div>

        <div class="loader" id="loader">
          <div class="coffee-loader"><div></div><div></div><div></div></div>
          <div class="mt-2">Searching caf√©s‚Ä¶</div>
        </div>

        <div id="results" class="results"></div>
        <div id="nores" class="text-center text-secondary py-4 d-none">
          <i class="fa-regular fa-face-sad-tear fa-2x mb-2"></i><div>No caf√©s found. Try another area.</div>
        </div>
      </div>
    </div>
  </section>
</main>

<footer class="py-4 mt-4">
  <div class="container small text-center">
    ¬© <span id="yr"></span> Coffee Finder Pro ‚Äî Tiles ¬© OpenStreetMap contributors ¬∑ Data: Overpass/Photon/Nominatim ¬∑ Privacy ¬∑ Disclaimer ¬∑ Made with love üá∏üá¶
  </div>
</footer>

<div class="toast-container"></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
(function(){
  'use strict';

  /* ======================= CONFIG ======================= */
  const CFG={
    photon:'https://photon.komoot.io/api/',
    nominatim:'https://nominatim.openstreetmap.org/search',
    overpass:[
      'https://overpass-api.de/api/interpreter',
      'https://overpass.kumi.systems/api/interpreter',
      'https://z.overpass-api.de/api/interpreter'
    ],
    timeout:20000
  };

  // Short but useful list; country bias makes geocoding honest
  const ISO=[
    ["","Global"],["sa","Saudi Arabia"],["us","United States"],["gb","United Kingdom"],
    ["ae","United Arab Emirates"],["tr","T√ºrkiye"],["eg","Egypt"],["fr","France"],
    ["de","Germany"],["es","Spain"],["it","Italy"],["jp","Japan"],["in","India"],
    ["id","Indonesia"],["pk","Pakistan"],["ru","Russia"],["br","Brazil"],["mx","Mexico"],
    ["ca","Canada"],["za","South Africa"]
  ];

  const BRAND_SVGS={
    "starbucks":"https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/starbucks.svg",
    "dunkin":"https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/dunkindonuts.svg",
    "tim":"https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/timhortons.svg",
    "% arabica":"https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/percent.svg",
    "arabica":"https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/percent.svg",
    "costa":"https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/costacoffee.svg",
    "gloria jeans":"https://cdn.jsdelivr.net/gh/simple-icons/simple-icons/icons/gloriajeans.svg"
  };

  /* ======================= DOM ======================= */
  const $=s=>document.querySelector(s), $$=s=>document.querySelectorAll(s);
  const dom={
    lang:$('#lang'), country:$('#country'), query:$('#query'), sugg:$('#suggestions'),
    btnSearch:$('#btnSearch'), radius:$('#radius'), fOpen:$('#fOpen'), fWifi:$('#fWifi'),
    fOutdoor:$('#fOutdoor'), minR:$('#minRating'), minRVal:$('#minRatingVal'),
    sort:$('#sort'), loader:$('#loader'), results:$('#results'), nores:$('#nores'),
    kpi:$('#kpi'), mapEl:$('#map'), btnFS:$('#btnFullscreen'), btnHere:$('#btnSearchHere'), btnLoc:$('#btnLocate')
  };

  /* ======================= STATE ======================= */
  const state={lang:'en',country:'',bias:null,map:null,cluster:null,origin:null,list:[],markers:[],isFullscreen:false};

  /* ======================= UTILS ======================= */
  const utils={
    esc:s=>s?s.replace(/[&<>"]/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[m])):'',
    fetchTO:(url,ms,opts={})=>{
      const ctrl=new AbortController();const t=setTimeout(()=>ctrl.abort(),ms);
      return fetch(url,{signal:ctrl.signal,...opts}).finally(()=>clearTimeout(t));
    },
    hav(lat1,lon1,lat2,lon2){
      const R=6371,dLat=(lat2-lat1)*Math.PI/180,dLon=(lon2-lon1)*Math.PI/180;
      const a=Math.sin(dLat/2)**2+Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)**2;
      return 2*R*Math.atan2(Math.sqrt(a),Math.sqrt(1-a));
    },
    dirUrl:(lat,lon)=>/iPad|iPhone|iPod/.test(navigator.userAgent)?`http://maps.apple.com/?daddr=${lat},${lon}`:`https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}`,
    smart(tags,dist){
      let s=2.7;
      if(tags.opening_hours) s+=0.7;
      if(tags.internet_access==='yes') s+=0.5;
      if(tags.outdoor_seating==='yes') s+=0.4;
      if(tags.brand) s+=0.2;
      if(/starbucks|dunkin|tim|arabica|costa/i.test(tags.name||'')) s+=0.3;
      if(dist>8) s-=0.8; else if(dist>5) s-=0.5; else if(dist>3) s-=0.2;
      return Math.max(0,Math.min(5,s));
    },
    mix:(smart,user)=>user?Math.max(0,Math.min(5,0.7*smart+0.3*user)):smart,
    openNow(tags){
      const h=tags.opening_hours; if(!h) return true; if(h.includes('24/7')) return true;
      const m=/(\d{1,2}):(\d{2})\s*-\s*(\d{1,2}):(\d{2})/.exec(h); if(!m) return true;
      const now=new Date(),mins=now.getHours()*60+now.getMinutes(),o=+m[1]*60+ +m[2],c=+m[3]*60+ +m[4];
      return c>o? (mins>=o&&mins<=c) : (mins>=o||mins<=c);
    },
    stars(r){
      let html='';const f=Math.floor(r),half=(r-f)>=.25&&(r-f)<.75;
      for(let i=0;i<f;i++) html+='<i class="fa-solid fa-star"></i>';
      if(half) html+='<i class="fa-solid fa-star-half-stroke"></i>';
      for(let i=(half?f+1:f);i<5;i++) html+='<i class="fa-regular fa-star"></i>';
      return html;
    },
    getRate:id=>{const v=localStorage.getItem('cf_rate_'+id);return v?parseFloat(v):null;},
    setRate:(id,v)=>localStorage.setItem('cf_rate_'+id,String(v)),
    toast(msg,type='info'){
      const c=document.querySelector('.toast-container')||(()=>{const d=document.createElement('div');d.className='toast-container';document.body.appendChild(d);return d})();
      const t=document.createElement('div');t.className='toast '+type;
      const icon=type==='error'?'circle-exclamation':type==='success'?'circle-check':'circle-info';
      t.innerHTML=`<i class="fa-solid fa-${icon} ${type==='error'?'text-danger':type==='success'?'text-success':'text-info'}"></i><span>${msg}</span>`;
      c.appendChild(t); setTimeout(()=>{t.style.opacity=0;setTimeout(()=>t.remove(),300)},3000);
    }
  };

  /* ======================= INIT ======================= */
  function init(){
    $('#yr').textContent=new Date().getFullYear();
    initMap(); populateCountries(); bindEvents(); tryIPBias();

    // restore last search if present
    const last=localStorage.getItem('cf_last');
    if(last){
      const obj=JSON.parse(last); dom.query.value=obj.q||''; if(obj.country) {dom.country.value=obj.country; state.country=obj.country;}
      searchAt(obj.lat,obj.lon,false,obj.zoom||13);
    }else{
      // initial useful view
      state.map.setView([25.285, 51.531], 12); // GCC dense cafes
      searchAt(25.285,51.531,false,12);
    }
  }

  function initMap(){
    state.map=L.map('map',{zoomControl:true,preferCanvas:true}).setView([23.8859,45.0792],5);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19,attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',crossOrigin:true}).addTo(state.map);
    state.cluster=L.markerClusterGroup({showCoverageOnHover:false,maxClusterRadius:50,chunkedLoading:true,spiderfyOnMaxZoom:true});
    state.map.addLayer(state.cluster);

    dom.btnHere.addEventListener('click',()=>{const c=state.map.getCenter(); searchAt(c.lat,c.lng,true,state.map.getZoom());});
    dom.btnLoc.addEventListener('click',geolocate);
    dom.btnFS.addEventListener('click',()=>{state.isFullscreen=!state.isFullscreen; dom.mapEl.classList.toggle('map-full'); dom.btnFS.innerHTML=state.isFullscreen?'<i class="fa-solid fa-minimize"></i>':'<i class="fa-solid fa-maximize"></i>'; setTimeout(()=>state.map.invalidateSize(),150);});
  }

  function populateCountries(){ dom.country.innerHTML=ISO.map(([c,n])=>`<option value="${c}">${c?c.toUpperCase()+' ‚Äî ':''}${n}</option>`).join(''); }

  function bindEvents(){
    let timer=null;
    dom.query.addEventListener('input',()=>{clearTimeout(timer); timer=setTimeout(suggest,160);});
    dom.query.addEventListener('keydown',e=>{if(e.key==='Enter'){e.preventDefault(); useTopSuggestion();}});
    dom.sugg.addEventListener('click',e=>{const a=e.target.closest('a[data-lat]'); if(!a) return; hideSuggest(); searchAt(+a.dataset.lat,+a.dataset.lon,false,13);});
    document.addEventListener('click',e=>{if(!dom.sugg.contains(e.target)&&e.target!==dom.query) hideSuggest();});
    dom.btnSearch.addEventListener('click',useTopSuggestion);

    dom.radius.addEventListener('change',()=>{ if(state.origin) searchAt(state.origin.lat,state.origin.lon,false,state.map.getZoom()); });
    dom.sort.addEventListener('change',renderResults);
    dom.fOpen.addEventListener('change',renderResults);
    dom.fWifi.addEventListener('change',renderResults);
    dom.fOutdoor.addEventListener('change',renderResults);
    dom.minR.addEventListener('input',()=>{dom.minRVal.textContent=parseFloat(dom.minR.value).toFixed(1); renderResults();});
    dom.lang.addEventListener('change',()=>{state.lang=dom.lang.value; suggest();});
    dom.country.addEventListener('change',panToCountry);
  }

  /* ======================= SUGGESTIONS ======================= */
  function hideSuggest(){dom.sugg.style.display='none'; dom.sugg.innerHTML='';}

  async function suggest(){
    const q=dom.query.value.trim(); if(q.length<1){hideSuggest(); return;}
    try{
      let items=await photonSuggest(q);
      if(!items.length) items=await nominatimSuggest(q);
      if(items.length) renderSuggestions(items); else hideSuggest();
    }catch(e){hideSuggest(); console.error('suggest',e);}
  }

  async function photonSuggest(q){
    const url=new URL(CFG.photon);
    url.searchParams.set('q',q); url.searchParams.set('limit','8'); url.searchParams.set('lang',state.lang);
    url.searchParams.set('layer','city,town,village,locality');
    if(state.country) url.searchParams.set('osm_tag','countrycode:'+state.country);
    if(state.bias){url.searchParams.set('lat',state.bias.lat); url.searchParams.set('lon',state.bias.lon);}
    const r=await utils.fetchTO(url,10000); const j=await r.json();
    return (j.features||[]).map(f=>{const p=f.properties||{};const label=[p.name,p.city,p.state,p.country].filter(Boolean).join(', ');return{label,lat:f.geometry.coordinates[1],lon:f.geometry.coordinates[0],importance:p.importance||0}}).sort((a,b)=>(b.importance||0)-(a.importance||0));
  }

  async function nominatimSuggest(q){
    const url=new URL(CFG.nominatim);
    url.searchParams.set('format','json'); url.searchParams.set('addressdetails','1'); url.searchParams.set('limit','5');
    url.searchParams.set('q',q); url.searchParams.set('accept-language',state.lang);
    if(state.country) url.searchParams.set('countrycodes',state.country);
    const r=await utils.fetchTO(url,12000); const j=await r.json();
    return j.map(i=>({label:i.display_name,lat:+i.lat,lon:+i.lon}));
  }

  function renderSuggestions(items){
    dom.sugg.innerHTML=items.slice(0,8).map(i=>`<a data-lat="${i.lat}" data-lon="${i.lon}"><i class="fa-solid fa-location-dot text-success"></i>${utils.esc(i.label)}</a>`).join('');
    dom.sugg.style.display='block';
  }

  async function useTopSuggestion(){
    if(dom.sugg.firstElementChild){ dom.sugg.firstElementChild.click(); return; }
    const q=dom.query.value.trim(); if(!q){dom.query.focus(); return;}
    try{
      let items=await photonSuggest(q).catch(()=>[]);
      if(!items.length) items=await nominatimSuggest(q);
      if(items&&items[0]){
        // Prefer country match if selected
        if(state.country){
          const name=(ISO.find(x=>x[0]===state.country)||[])[1]||'';
          const match=items.find(x=>x.label.toLowerCase().includes(name.toLowerCase()))||items[0];
          searchAt(match.lat,match.lon,false,13); return;
        }
        searchAt(items[0].lat,items[0].lon,false,13);
      }
    }catch(e){utils.toast('Could not find location','error');}
  }

  /* ======================= COUNTRY PAN ======================= */
  async function panToCountry(){
    state.country=dom.country.value||''; hideSuggest();
    if(!state.country){state.bias=null; return;}
    const name=(ISO.find(i=>i[0]===state.country)||[])[1]||state.country;
    const url=new URL(CFG.nominatim); url.searchParams.set('format','json'); url.searchParams.set('limit','1'); url.searchParams.set('q',name); url.searchParams.set('countrycodes',state.country);
    try{
      const r=await utils.fetchTO(url,12000); const j=await r.json(); if(!j[0]) return;
      const bb=j[0].boundingbox, sw=[+bb[0],+bb[2]], ne=[+bb[1],+bb[3]];
      state.map.fitBounds([sw,ne],{maxZoom:7});
      state.bias={lat:(sw[0]+ne[0])/2, lon:(sw[1]+ne[1])/2};
      searchAt(state.bias.lat,state.bias.lon,false,9);
    }catch(e){console.error('panToCountry',e);}
  }

  /* ======================= SEARCH ======================= */
  function startLoading(){dom.loader.style.display='block'; dom.results.innerHTML=''; dom.nores.classList.add('d-none'); dom.kpi.textContent='Searching‚Ä¶'; state.cluster.clearLayers(); state.markers=[];}
  function stopLoading(){dom.loader.style.display='none';}

  function searchAt(lat,lon,fromMap=false,zoom=13){
    hideSuggest(); state.origin={lat,lon}; state.map.setView([lat,lon],zoom);
    // store last search
    localStorage.setItem('cf_last', JSON.stringify({lat,lon,zoom,q:dom.query.value,country:state.country}));
    startLoading(); findCafes(lat,lon, parseInt(dom.radius.value,10));
  }

  async function overpassQuery(q){
    // POST with failover, then GET with failover
    for(const ep of CFG.overpass){
      try{
        const r=await utils.fetchTO(ep,CFG.timeout,{method:'POST',headers:{'Content-Type':'application/x-www-form-urlencoded; charset=UTF-8','Accept':'application/json'},body:'data='+encodeURIComponent(q)});
        if(r.ok) return await r.json();
      }catch(e){/* try next */}
    }
    for(const ep of CFG.overpass){
      try{
        const r=await utils.fetchTO(ep+'?data='+encodeURIComponent(q),CFG.timeout);
        if(r.ok) return await r.json();
      }catch(e){/* try next */}
    }
    throw new Error('All Overpass endpoints failed');
  }

  async function findCafes(lat,lon,r){
    // Wider net: cafes, coffee shops, and coffee-branded fast_food/restaurant
    const brands="(?i)(coffee|starbucks|costa|arabica|dunkin|tim|gloria|peets)";
    const q=`
      [out:json][timeout:30];
      (
        node["amenity"="cafe"](around:${r},${lat},${lon});
        way["amenity"="cafe"](around:${r},${lat},${lon});
        node["shop"="coffee"](around:${r},${lat},${lon});
        way["shop"="coffee"](around:${r},${lat},${lon});
        node["amenity"="fast_food"]["name"~"${brands}"](around:${r},${lat},${lon});
        way["amenity"="fast_food"]["name"~"${brands}"](around:${r},${lat},${lon});
        node["amenity"="restaurant"]["name"~"${brands}"](around:${r},${lat},${lon});
        way["amenity"="restaurant"]["name"~"${brands}"](around:${r},${lat},${lon});
      );
      out center tags;
    `;
    try{
      const data=await overpassQuery(q); processCafes(data,lat,lon);
    }catch(e){
      stopLoading(); dom.kpi.textContent='Search failed. Please try again.'; dom.results.innerHTML=`<div class="text-center text-secondary py-4"><i class="fa-solid fa-wifi fa-2x mb-2"></i><div>Network error. Click ‚ÄúSearch this area‚Äù or ‚ÄúFind‚Äù to retry.</div></div>`;
      utils.toast('Search failed. Please try again.','error'); console.error('overpass',e);
    }
  }

  function processCafes(data,olat,olon){
    const el=data.elements||[];
    state.list=el.map(e=>{
      const c=e.type==='way'? e.center : {lat:e.lat,lon:e.lon};
      const t=e.tags||{}, name=t.name||t.brand||'Caf√©';
      const d=utils.hav(olat,olon,c.lat,c.lon), sr=utils.smart(t,d), ur=utils.getRate(e.id), cr=utils.mix(sr,ur);
      return {id:e.id,lat:c.lat,lon:c.lon,name,tags:t,distance:d,smartRating:sr,userRating:ur,rating:cr};
    });
    renderResults(); stopLoading();
  }

  /* ======================= RENDER ======================= */
  function renderResults(){
    let list=state.list.slice();
    if(dom.fWifi.checked) list=list.filter(c=>c.tags.internet_access==='yes');
    if(dom.fOutdoor.checked) list=list.filter(c=>c.tags.outdoor_seating==='yes');
    if(dom.fOpen.checked) list=list.filter(c=>utils.openNow(c.tags));
    const min=parseFloat(dom.minR.value||0); list=list.filter(c=>c.rating>=min);

    const mode=dom.sort.value;
    list.sort((a,b)=> mode==='name' ? (a.name||'').localeCompare(b.name||'')
                      : mode==='rating' ? (b.rating-a.rating)
                      : mode==='hours' ? ((b.tags.opening_hours?1:0)-(a.tags.opening_hours?1:0))
                      : (a.distance-b.distance));

    updateMapMarkers(list); updateResultsList(list);
    dom.kpi.textContent=list.length?`Showing ${list.length} caf√©s`:'No caf√©s';
    dom.nores.classList.toggle('d-none', !!list.length);
  }

  function updateMapMarkers(list){
    state.cluster.clearLayers(); state.markers=[];
    const icon=L.divIcon({className:'',html:`<div class="steam"></div><div class="cup"><div class="foam"></div></div>`,iconSize:[26,26],iconAnchor:[13,18]});
    list.forEach(c=>{
      const m=L.marker([c.lat,c.lon],{icon}).bindPopup(popupHtml(c));
      m.on('mouseover',()=>m.openPopup()); state.cluster.addLayer(m); state.markers.push(m);
    });
  }

  function popupHtml(c){
    const addr=[c.tags['addr:street'],c.tags['addr:city']].filter(Boolean).join(', ');
    return `
      <div><strong>${utils.esc(c.name)}</strong></div>
      <div class="stars my-1">${utils.stars(c.rating)} <span class="text-secondary small">(${c.rating.toFixed(1)})</span></div>
      <div class="small text-secondary">${c.distance.toFixed(1)} km</div>
      ${addr?`<div class="small"><i class="fa-solid fa-location-dot me-1"></i>${utils.esc(addr)}</div>`:''}
      <div class="mt-2 d-flex gap-1 flex-wrap">
        <a class="btn btn-sm btn-route" target="_blank" href="${utils.dirUrl(c.lat,c.lon)}"><i class="fa-solid fa-route me-1"></i>Directions</a>
        <a class="btn btn-sm btn-outline-light" target="_blank" href="https://www.openstreetmap.org/?mlat=${c.lat}&mlon=${c.lon}#map=18/${c.lat}/${c.lon}">OSM</a>
      </div>`;
  }

  function updateResultsList(list){
    dom.results.innerHTML=list.map((c,i)=>cardHtml(c,i)).join('');
    addCardUX(list);
  }

  function brandAvatar(name){
    const n=(name||'').toLowerCase();
    const key=Object.keys(BRAND_SVGS).find(k=>n.includes(k));
    if(key) return `<div class="avatar" title="${key}"><img src="${BRAND_SVGS[key]}" alt="${key}" loading="lazy"></div>`;
    const L=(name||'?').trim().charAt(0).toUpperCase();
    return `<div class="avatar"><div class="letter">${L}</div></div>`;
  }

  function cardHtml(c,idx){
    const addr=[c.tags['addr:street'],c.tags['addr:city']].filter(Boolean).join(', ');
    const ur=c.userRating||0;
    return `
      <div class="card card-cafe mb-3 pointer" data-id="${c.id}" data-idx="${idx}">
        <div class="card-body d-flex gap-3">
          ${brandAvatar(c.name)}
          <div class="flex-grow-1">
            <div class="d-flex justify-content-between align-items-start">
              <div class="fw-bold">${utils.esc(c.name)}</div>
              <div class="text-secondary small">${c.distance.toFixed(1)} km</div>
            </div>
            <div class="stars">${utils.stars(c.rating)} <span class="text-secondary small">(${c.rating.toFixed(1)})</span></div>
            ${addr?`<div class="small text-secondary"><i class="fa-solid fa-location-dot me-1"></i>${utils.esc(addr)}</div>`:''}
            <div class="mt-1 d-flex gap-2 flex-wrap small">
              ${c.tags.internet_access==='yes'?'<span class="chip"><i class="fa-solid fa-wifi me-1"></i>Wi-Fi</span>':''}
              ${c.tags.outdoor_seating==='yes'?'<span class="chip"><i class="fa-solid fa-umbrella-beach me-1"></i>Outdoor</span>':''}
            </div>
            <div class="mt-2 rate">
              ${[1,2,3,4,5].map(v=>`<i class="fa-solid fa-star ${ur&&v<=ur?'text-warning':''}" data-v="${v}"></i>`).join(' ')}
            </div>
          </div>
        </div>
      </div>`;
  }

  function addCardUX(list){
    $$('.card-cafe').forEach(card=>{
      const i=+card.dataset.idx;
      card.addEventListener('mouseenter',()=>{if(state.markers[i]) state.markers[i].openPopup();});
      card.addEventListener('click',e=>{
        if(!e.target.closest('.rate')){ if(state.markers[i]){ state.map.setView(state.markers[i].getLatLng(),16); state.markers[i].openPopup(); } }
      });
    });
    $$('.rate i').forEach(star=>{
      star.addEventListener('click',e=>{
        const card=e.target.closest('.card-cafe'); const id=card.dataset.id; const v=+e.target.dataset.v;
        utils.setRate(id,v); const cafe=state.list.find(x=>String(x.id)===id); if(cafe){ cafe.userRating=v; cafe.rating=utils.mix(cafe.smartRating,v); renderResults(); }
      });
    });
  }

  /* ======================= GEOLOCATION / IP BIAS ======================= */
  function geolocate(){
    if(!navigator.geolocation){utils.toast('Geolocation is not supported by your browser','error');return;}
    utils.toast('Getting your location‚Ä¶','info');
    navigator.geolocation.getCurrentPosition(
      pos=>{const {latitude,longitude}=pos.coords; state.bias={lat:latitude,lon:longitude}; utils.toast('Using your current location','success'); searchAt(latitude,longitude,false,14);},
      ()=>utils.toast('Could not get your location. Try searching by city.','error'),
      {enableHighAccuracy:true,timeout:10000,maximumAge:600000}
    );
  }

  async function tryIPBias(){
    try{
      const r=await utils.fetchTO('https://ipapi.co/json/',6000); const j=await r.json();
      if(j&&j.country_code){state.country=(j.country_code||'').toLowerCase(); const hit=ISO.find(x=>x[0]===state.country); if(hit) dom.country.value=state.country;}
      if(j.latitude&&j.longitude){state.bias={lat:j.latitude,lon:j.longitude};}
    }catch(e){/* non critical */}
  }

  /* ======================= GO ======================= */
  if(document.readyState==='loading'){document.addEventListener('DOMContentLoaded',init);} else {init();}
})();
</script>
</body>
</html>
