<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Coffee Finder Pro ‚òï ‚Äî Worldwide caf√©s (OSM)</title>
<meta name="description" content="Find caf√©s anywhere in the world. OpenStreetMap based, fast, accurate, no API keys." />
<link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>‚òï</text></svg>">

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- Font Awesome -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
<!-- Leaflet -->
<link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet">
<!-- MarkerCluster -->
<link href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" rel="stylesheet">
<link href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" rel="stylesheet">

<style>
  :root{
    --bg:#f7f5f2;
    --panel:#ffffff;
    --ink:#2a211c;
    --muted:#7a6e67;
    --brand:#c86b40;
    --brand2:#7a4b3a;
  }
  html,body{height:100%}
  body{background:linear-gradient(135deg,#faf9f8,#f3efe9); color:var(--ink)}
  header{
    background:radial-gradient(1200px 400px at 10% -10%, #4a3a36 0, #332826 60%, #2b2220 100%);
    color:#fff; padding:38px 0 22px; box-shadow:0 10px 30px rgba(0,0,0,.15)
  }
  .brand{font-weight:800; font-size:2rem; letter-spacing:.3px}
  .tag{opacity:.85}
  .search-card{
    background:var(--panel); border-radius:16px; margin-top:-22px; padding:16px 16px 10px;
    box-shadow:0 14px 30px rgba(0,0,0,.10)
  }
  .btn-brand{background:linear-gradient(135deg,var(--brand),#e36a44); border:0}
  .btn-brand:hover{filter:brightness(1.02)}
  #map{height:62vh; border-radius:14px; box-shadow:0 10px 24px rgba(0,0,0,.12)}
  .results{max-height:62vh; overflow:auto}
  .card-cafe{border:0; border-radius:14px; box-shadow:0 8px 20px rgba(0,0,0,.06)}
  .card-cafe:hover{transform:translateY(-2px); box-shadow:0 12px 26px rgba(0,0,0,.10)}
  .cmeta{font-size:.9rem; color:var(--muted)}
  .loader{display:none; text-align:center; padding:16px}
  .pill{border-radius:999px; background:#f1ece7; padding:.25rem .6rem; font-size:.8rem}
  .country-select{min-width:130px}
  .suggest{position:absolute; inset:auto 0 0 0; top:100%; z-index:20; background:var(--panel); border-radius:12px; box-shadow:0 10px 30px rgba(0,0,0,.15); overflow:hidden; display:none}
  .suggest a{display:flex; gap:.5rem; align-items:center; padding:.55rem .8rem; color:var(--ink); text-decoration:none}
  .suggest a:hover{background:#f6f3ef}
  .leaflet-popup-content{margin:.4rem .6rem}
  .cof-ic{color:#7b4e3a; font-size:18px}
  footer{padding:22px 0; color:#fff; background:#2b2220; margin-top:26px}
  .pointer{cursor:pointer}
</style>
</head>
<body>

<header>
  <div class="container">
    <div class="d-flex align-items-center justify-content-between flex-wrap gap-2">
      <div class="brand"><i class="fa-solid fa-mug-saucer me-2"></i>Coffee Finder Pro</div>
      <div class="tag">OpenStreetMap ‚Ä¢ Overpass ‚Ä¢ Zero-key</div>
    </div>
  </div>
</header>

<main class="container">
  <!-- Search -->
  <section class="search-card">
    <div class="row g-2 align-items-stretch">
      <div class="col-12 col-lg-6 position-relative">
        <div class="input-group">
          <span class="input-group-text bg-white"><i class="fa-solid fa-magnifying-glass"></i></span>
          <input id="q" class="form-control" placeholder="City, area or address (e.g., Riyadh, Saudi Arabia)">
          <button id="btnSearch" class="btn btn-brand text-white px-4"><i class="fa-solid fa-search me-1"></i>Search</button>
        </div>
        <!-- suggestions -->
        <div id="suggestions" class="suggest rounded-3"></div>
      </div>

      <div class="col-7 col-lg-3">
        <div class="input-group">
          <span class="input-group-text bg-white"><i class="fa-solid fa-globe"></i></span>
          <select id="country" class="form-select country-select">
            <option value="">üåç Global</option>
          </select>
        </div>
      </div>

      <div class="col-5 col-lg-3 d-grid">
        <button id="btnLocate" class="btn btn-outline-secondary"><i class="fa-solid fa-location-crosshairs me-1"></i>Use my location</button>
      </div>
    </div>
  </section>

  <!-- Map + Results -->
  <section class="mt-3">
    <div class="row g-3">
      <div class="col-lg-8"><div id="map"></div></div>
      <div class="col-lg-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="h5 m-0"><i class="fa-solid fa-list"></i> Results</div>
          <select id="sort" class="form-select form-select-sm w-auto">
            <option value="distance">by distance</option>
            <option value="name">by name</option>
            <option value="hours">open first</option>
          </select>
        </div>
        <div class="loader" id="loader"><i class="fa-solid fa-spinner fa-spin me-2"></i>Searching caf√©s‚Ä¶</div>
        <div id="results" class="results"></div>
        <div id="nores" class="text-center text-muted d-none py-4">
          <i class="fa-regular fa-face-frown-open fa-2x mb-2"></i>
          <div>No caf√©s found. Zoom out or try another area.</div>
        </div>
      </div>
    </div>
  </section>
</main>

<footer>
  <div class="container small text-center">
    ¬© <span id="yr"></span> Coffee Finder Pro ‚Äî Tiles ¬© OSM contributors ‚Ä¢ Data: Overpass/OSM.
  </div>
</footer>

<!-- JS: Bootstrap bundle, Leaflet & cluster -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

<script>
(() => {
  // -------------------- MAP INIT --------------------
  const map = L.map('map', { zoomControl: false }).setView([20, 0], 3);
  L.control.zoom({ position: 'topright' }).addTo(map);

  const tiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom: 19,
    attribution: '&copy; OpenStreetMap'
  }).addTo(map);

  const cluster = L.markerClusterGroup({ showCoverageOnHover:false, maxClusterRadius:50 });
  map.addLayer(cluster);

  // -------------------- STATE --------------------
  let centerBias = null;      // {lat, lon} used to bias searches
  let currentOrigin = null;   // last searched center {lat, lon}
  let cafes = [];             // results
  let markers = [];           // markers for linking with list
  const resultsEl = document.getElementById('results');
  const noresEl = document.getElementById('nores');
  const loaderEl = document.getElementById('loader');

  // -------------------- UTIL --------------------
  const deg2rad = d => d*Math.PI/180;
  function haversine(lat1,lon1,lat2,lon2) {
    const R = 6371, dLat = deg2rad(lat2-lat1), dLon = deg2rad(lon2-lon1);
    const a = Math.sin(dLat/2)**2 + Math.cos(deg2rad(lat1))*Math.cos(deg2rad(lat2))*Math.sin(dLon/2)**2;
    return R*2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  }
  function show(el){ el.classList.remove('d-none'); }
  function hide(el){ el.classList.add('d-none'); }
  function startLoading(){ loaderEl.style.display='block'; resultsEl.innerHTML=''; hide(noresEl); }
  function stopLoading(){ loaderEl.style.display='none'; }

  // -------------------- COUNTRY SELECT (auto-detect) --------------------
  const countrySelect = document.getElementById('country');

  // Build quick list of the most common codes first to keep the UI snappy
  const TOP = [
    ["sa","Saudi Arabia"],["ae","United Arab Emirates"],["qa","Qatar"],["kw","Kuwait"],
    ["bh","Bahrain"],["om","Oman"],["us","United States"],["gb","United Kingdom"],
    ["ca","Canada"],["de","Germany"],["fr","France"],["es","Spain"],["it","Italy"],
    ["tr","Turkey"],["in","India"],["jp","Japan"],["kr","South Korea"]
  ];
  for (const [code,name] of TOP){
    const opt = document.createElement('option');
    opt.value = code;
    opt.textContent = name;
    countrySelect.appendChild(opt);
  }

  // Best-effort IP geolocate to set default country & bias
  (async () => {
    try{
      const r = await fetch('https://ipapi.co/json/');
      if (!r.ok) throw 0;
      const j = await r.json();
      if (j && j.country_code) {
        countrySelect.value = j.country_code.toLowerCase();
        if (j.latitude && j.longitude) centerBias = { lat:j.latitude, lon:j.longitude };
      }
    }catch(_){}
  })();

  // -------------------- SUGGESTIONS (Photon) --------------------
  const q = document.getElementById('q');
  const sug = document.getElementById('suggestions');
  let sugTimer = null;

  q.addEventListener('input', () => {
    const val = q.value.trim();
    if (val.length < 2) { sug.style.display='none'; sug.innerHTML=''; return; }
    clearTimeout(sugTimer);
    sugTimer = setTimeout(loadSuggestions, 200);
  });

  async function loadSuggestions(){
    const val = q.value.trim();
    if (!val) return;
    // Photon supports bias with lat/lon; for strong country bias we‚Äôll use Nominatim on search
    const url = new URL('https://photon.komoot.io/api/');
    url.searchParams.set('q', val);
    url.searchParams.set('limit','6');
    url.searchParams.set('lang','en');
    if (centerBias){ url.searchParams.set('lat', centerBias.lat); url.searchParams.set('lon', centerBias.lon); }

    try{
      const r = await fetch(url);
      const j = await r.json();
      const items = (j.features||[]).map(f=>{
        const props = f.properties||{};
        const line = [props.name, props.city, props.state, props.country].filter(Boolean).join(', ');
        return {
          label: line || props.name,
          lat: f.geometry.coordinates[1],
          lon: f.geometry.coordinates[0]
        };
      }).slice(0,6);

      if (!items.length){ sug.style.display='none'; sug.innerHTML=''; return; }
      sug.innerHTML = items.map(i => `
        <a class="pointer" data-lat="${i.lat}" data-lon="${i.lon}">
          <i class="fa-solid fa-location-dot text-danger"></i>
          <span>${escapeHtml(i.label)}</span>
        </a>
      `).join('');
      sug.style.display='block';
    }catch(e){
      sug.style.display='none';
      sug.innerHTML='';
    }
  }
  sug.addEventListener('click', e=>{
    const a = e.target.closest('a[data-lat]');
    if (!a) return;
    const lat = parseFloat(a.dataset.lat), lon = parseFloat(a.dataset.lon);
    sug.style.display='none';
    sug.innerHTML='';
    q.blur();
    goSearch(lat,lon, a.textContent.trim());
  });
  document.addEventListener('click', e=>{
    if (!sug.contains(e.target) && e.target!==q) { sug.style.display='none'; }
  });

  // -------------------- SEARCH (Nominatim + country bias) --------------------
  document.getElementById('btnSearch').addEventListener('click', ()=>{
    if (!q.value.trim()) { q.focus(); return; }
    geocodeText(q.value.trim());
  });
  q.addEventListener('keydown', e=>{
    if (e.key==='Enter'){ e.preventDefault(); document.getElementById('btnSearch').click(); }
  });

  async function geocodeText(text){
    // Strong country bias using Nominatim & countrycodes
    const url = new URL('https://nominatim.openstreetmap.org/search');
    url.searchParams.set('format','json');
    url.searchParams.set('addressdetails','1');
    url.searchParams.set('limit','5');
    url.searchParams.set('q', text);
    const cc = (countrySelect.value||'').trim();
    if (cc) url.searchParams.set('countrycodes', cc); // fixes "Riyadh" ‚Üí Saudi, not Mauritania
    try{
      startLoading();
      const r = await fetch(url.toString(), { headers: { 'Accept-Language':'en' }});
      const j = await r.json();
      if (!j.length){ stopLoading(); showNoResults('No matching location. Try adding the country.'); return; }
      // Choose best: if user provided country bias, prefer those; else top result
      const loc = j[0];
      const lat = parseFloat(loc.lat), lon = parseFloat(loc.lon);
      const label = (loc.display_name||'').split(',').slice(0,3).join(', ');
      goSearch(lat,lon,label);
    }catch(err){
      stopLoading();
      showNoResults('Search failed. Please try again.');
    }
  }

  function goSearch(lat,lon,label){
    currentOrigin = {lat,lon};
    if (!centerBias) centerBias = {lat,lon};
    map.setView([lat,lon], 13);
    findCafesWithExpansion(lat,lon);
  }

  // -------------------- CURRENT LOCATION --------------------
  document.getElementById('btnLocate').addEventListener('click', ()=>{
    if (!navigator.geolocation) return alert('Geolocation not supported in this browser.');
    startLoading();
    navigator.geolocation.getCurrentPosition(pos=>{
      const {latitude:lat, longitude:lon} = pos.coords;
      currentOrigin = {lat,lon};
      centerBias = {lat,lon};
      map.setView([lat,lon], 14);
      findCafesWithExpansion(lat,lon);
    }, _=>{
      stopLoading();
      alert('Could not get your location. Please search by city instead.');
    }, { enableHighAccuracy:true, timeout:10000 });
  });

  // -------------------- OVERPASS SEARCH (with radius expansion) --------------------
  async function findCafesWithExpansion(lat,lon){
    // expand radius 2km ‚Üí 4km ‚Üí 8km until we get results (cap 10km)
    const radii = [2000, 4000, 8000, 10000];
    let found = [];
    for (const r of radii){
      found = await queryCafes(lat,lon,r);
      if (found.length >= 8 || r === radii[radii.length-1]) break; // enough or last try
    }
    stopLoading();
    renderResults(found, lat, lon);
  }

  async function queryCafes(lat,lon,radius){
    const q = `
      [out:json][timeout:25];
      (
        node["amenity"="cafe"](around:${radius},${lat},${lon});
        way["amenity"="cafe"](around:${radius},${lat},${lon});
        node["shop"="coffee"](around:${radius},${lat},${lon});
      );
      out center tags;
    `;
    try{
      const r = await fetch('https://overpass-api.de/api/interpreter', { method:'POST', body:q });
      const j = await r.json();
      const els = j.elements || [];
      return els.map(e=>{
        const c = e.type === 'way' ? e.center : { lat:e.lat, lon:e.lon };
        const name = (e.tags && e.tags.name) ? e.tags.name : (e.tags && e.tags.brand) ? e.tags.brand : 'Unnamed caf√©';
        const dist = currentOrigin ? haversine(currentOrigin.lat,currentOrigin.lon,c.lat,c.lon) : null;
        return {
          id: e.id, lat:c.lat, lon:c.lon, tags:(e.tags||{}),
          name, distance: dist, opening: e.tags?.opening_hours || null
        };
      });
    }catch(_){ return []; }
  }

  // -------------------- RENDER --------------------
  function renderResults(list, originLat, originLon){
    cafes = list.slice();
    // default sort by distance
    cafes.sort((a,b)=> (a.distance??1e9) - (b.distance??1e9));
    cluster.clearLayers();
    markers.length = 0;

    if (!cafes.length){
      resultsEl.innerHTML='';
      show(noresEl);
      return;
    }
    hide(noresEl);

    // add markers
    const icon = L.divIcon({ className:'', html:'<i class="fa-solid fa-mug-hot cof-ic"></i>', iconSize:[24,24], iconAnchor:[12,12] });
    cafes.forEach((cafe, idx)=>{
      const m = L.marker([cafe.lat, cafe.lon], { icon }).bindPopup(popupHtml(cafe));
      m.on('mouseover', ()=> m.openPopup());
      cluster.addLayer(m);
      markers.push(m);
    });

    // fit slightly (keep origin center)
    map.setView([originLat, originLon], Math.max(12, map.getZoom()));

    // render list
    resultsEl.innerHTML = cafes.map((cafe, idx)=> cardHtml(cafe, idx)).join('');
    // link hover ‚Üî marker
    resultsEl.querySelectorAll('[data-idx]').forEach(el=>{
      const i = +el.dataset.idx;
      el.addEventListener('mouseenter', ()=> markers[i].openPopup());
      el.addEventListener('click', ()=> { map.setView(markers[i].getLatLng(), 16); markers[i].openPopup(); });
    });
  }

  function popupHtml(c){
    const web = c.tags.website || c.tags['contact:website'];
    const phone = c.tags.phone || c.tags['contact:phone'];
    const open = c.opening ? `<div class="small"><i class="fa-regular fa-clock me-1"></i>${escapeHtml(c.opening)}</div>` : '';
    const line = `
      <div><strong>${escapeHtml(c.name)}</strong></div>
      ${c.distance!=null ? `<div class="small text-muted">${c.distance.toFixed(1)} km away</div>`:''}
      ${open}
      <div class="mt-1 d-flex gap-1 flex-wrap">
        <a class="btn btn-sm btn-primary" target="_blank" href="${directionsUrl(c.lat,c.lon)}"><i class="fa-solid fa-turn-up me-1"></i>Directions</a>
        <a class="btn btn-sm btn-outline-secondary" target="_blank" href="https://www.openstreetmap.org/?mlat=${c.lat}&mlon=${c.lon}#map=19/${c.lat}/${c.lon}">OSM</a>
        ${web ? `<a class="btn btn-sm btn-outline-secondary" target="_blank" href="${safeUrl(web)}">Website</a>`:''}
        ${phone ? `<a class="btn btn-sm btn-outline-secondary" href="tel:${encodeURIComponent(phone)}">Call</a>`:''}
      </div>
    `;
    return line;
  }

  function cardHtml(c, idx){
    const web = c.tags.website || c.tags['contact:website'];
    const phone = c.tags.phone || c.tags['contact:phone'];
    const cuisine = c.tags.cuisine ? `<span class="pill">cuisine: ${escapeHtml(c.tags.cuisine)}</span>` : '';
    const wifi = c.tags.internet_access === 'yes' ? `<span class="pill"><i class="fa-solid fa-wifi"></i> Wi-Fi</span>` : '';
    const outdoor = c.tags.outdoor_seating === 'yes' ? `<span class="pill"><i class="fa-solid fa-umbrella-beach"></i> outdoor</span>` : '';
    const open = c.opening ? `<div class="cmeta"><i class="fa-regular fa-clock me-1"></i>${escapeHtml(c.opening)}</div>` : '';

    return `
      <div class="card card-cafe mb-2 pointer" data-idx="${idx}">
        <div class="card-body">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <div class="fw-bold">${escapeHtml(c.name)}</div>
              <div class="cmeta">${c.distance!=null ? `${c.distance.toFixed(1)} km away` : ''}</div>
            </div>
            <div class="text-nowrap">
              <a class="btn btn-sm btn-outline-primary" target="_blank" href="${directionsUrl(c.lat,c.lon)}"><i class="fa-solid fa-route"></i></a>
              <a class="btn btn-sm btn-outline-secondary" target="_blank" href="https://www.openstreetmap.org/?mlat=${c.lat}&mlon=${c.lon}#map=19/${c.lat}/${c.lon}"><i class="fa-brands fa-openid"></i></a>
            </div>
          </div>
          ${open}
          <div class="mt-2 d-flex gap-1 flex-wrap">${cuisine}${wifi}${outdoor}</div>
          <div class="mt-2 d-flex gap-2 flex-wrap">
            ${web ? `<a class="text-decoration-none" target="_blank" href="${safeUrl(web)}"><i class="fa-solid fa-globe me-1"></i>Website</a>`:''}
            ${phone ? `<a class="text-decoration-none" href="tel:${encodeURIComponent(phone)}"><i class="fa-solid fa-phone me-1"></i>Call</a>`:''}
          </div>
        </div>
      </div>`;
  }

  // -------------------- SORT --------------------
  document.getElementById('sort').addEventListener('change', e=>{
    const mode = e.target.value;
    if (!cafes.length) return;
    if (mode==='name') cafes.sort((a,b)=> (a.name||'').localeCompare(b.name||''));
    else if (mode==='hours') cafes.sort((a,b)=> ((!b.opening) - (!a.opening))); // "openings" first
    else cafes.sort((a,b)=> (a.distance??1e9) - (b.distance??1e9));
    resultsEl.innerHTML = cafes.map((c,i)=> cardHtml(c,i)).join('');
    resultsEl.querySelectorAll('[data-idx]').forEach(el=>{
      const i = +el.dataset.idx;
      el.addEventListener('mouseenter', ()=> markers[i].openPopup());
      el.addEventListener('click', ()=> { map.setView(markers[i].getLatLng(), 16); markers[i].openPopup(); });
    });
  });

  // -------------------- HELPERS --------------------
  function directionsUrl(lat,lon){
    // Prefer platform-agnostic: if on iOS, apple maps; else google if available; else OSM
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    if (isIOS) return `http://maps.apple.com/?daddr=${lat},${lon}`;
    return `https://www.google.com/maps/dir/?api=1&destination=${lat},${lon}`;
  }
  function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }
  function safeUrl(u){ try{ const x=new URL(u, location.href); return x.href; }catch(_){ return '#'; } }
  function showNoResults(msg){ resultsEl.innerHTML=`<div class="text-center text-muted py-4">${escapeHtml(msg)}</div>`; show(noresEl); }

  // Footer year
  document.getElementById('yr').textContent = new Date().getFullYear();

})();
</script>
</body>
</html>
