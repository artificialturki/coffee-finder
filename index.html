<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>☕️ كوفي فندر برو — الإصدار المتطور</title>
<meta name="description" content="أقوى أداة عربية للعثور على المقاهي في السعودية مع ميزات متقدمة وتصميم عصري" />
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.8em' font-size='80'>☕</text></svg>">

<!-- مكتبات خارجية -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
<link href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" rel="stylesheet">
<link href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css" rel="stylesheet">
<link href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css" rel="stylesheet">

<style>
:root{
  --ink:#f3fff9;--muted:#a9d3c5;--bg1:#0b1411;--bg2:#0c1e17;--panel:#0f2a20cc;--line:#1f4e3f;
  --mint:#39eba1;--mint2:#1cc57d;--neon:#59ffd4;--accent:#ffd54f;--radius:16px;--shadow:0 8px 24px rgba(0,0,0,.28);
  --card:#132820;--input:#0e261e;--text:#eafff6;--muted2:#cfe7df;
  
  /* ألوان القهوة للمواضيع */
  --coffee-theme-1: #734f35;
  --coffee-theme-2: #8B4513;
  --coffee-theme-3: #6F4E37;
  --coffee-theme-4: #5C4033;
  --coffee-theme-5: #C4A484;
}
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%}
body{
  font-family: "Cairo", ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
  color:var(--text);
  background: radial-gradient(1200px 500px at 20% -10%, #113428 0, var(--bg1) 55%, var(--bg2) 100%);
  overflow-x:hidden; line-height:1.65;
  transition: background 0.5s ease;
}

/* خلفية نجوم متلألئة + بارالاكس */
.bg-stars,.bg-stars-2{position:fixed;inset:0;z-index:-2;pointer-events:none}
.bg-stars{background-image:
 radial-gradient(2px 2px at 12% 18%, #aaffee44 50%, transparent 52%),
 radial-gradient(2px 2px at 80% 30%, #aaffee33 50%, transparent 52%),
 radial-gradient(1.5px 1.5px at 60% 70%, #aaffee33 50%, transparent 52%),
 radial-gradient(1.5px 1.5px at 30% 80%, #aaffee33 50%, transparent 52%)}
.bg-stars-2{opacity:.55;filter:blur(.4px)}

/* هيدر */
header{
  position:sticky;top:0;z-index:50;
  background:linear-gradient(180deg, rgba(15,42,32,.92), rgba(15,42,32,.62));
  backdrop-filter:blur(8px);border-bottom:1px solid var(--line);box-shadow:var(--shadow);padding:.75rem 0;
}
.brand{font-weight:900;font-size:2rem;display:flex;align-items:center;gap:.6rem;cursor:pointer}
.brand i{color:var(--neon);filter:drop-shadow(0 0 8px #2eeaa088)}
.brand .glow{color:#eafff9;text-shadow:0 0 12px #2eeaa088,0 0 22px #2eeaa055}

/* لوحة التحكم */
.panel{background:var(--panel);border:1px solid var(--line);border-radius:var(--radius);box-shadow:var(--shadow)}
.chip-input{background:var(--input);border:1px solid var(--line);border-radius:14px;padding:.7rem .9rem;display:flex;align-items:center;gap:.7rem}
.chip-input input{all:unset;color:var(--text);width:520px;max-width:70vw;font-size:1.05rem}
.btn-mint{background:linear-gradient(180deg,var(--mint),var(--mint2));color:#062016;font-weight:800;border:0;border-radius:12px;padding:.6rem 1rem;box-shadow:0 10px 24px #22d18940;cursor:pointer}
.suggest{position:absolute;top:100%;left:0;right:0;z-index:60;display:none;max-height:320px;overflow:auto;border-radius:0 0 var(--radius) var(--radius)}
.suggest a{display:flex;align-items:center;gap:.55rem;padding:.6rem .8rem;color:var(--text);text-decoration:none;background:#0f231c;border-bottom:1px solid #1a4536}
.suggest a:hover{background:#123b2d}

/* خريطة */
#map{height:60vh;min-height:360px;border-radius:var(--radius);box-shadow:var(--shadow);position:relative;outline:1px solid var(--line)}
.map-full{position:fixed!important;inset:0!important;width:100vw!important;height:100vh!important;z-index:1050!important;border-radius:0!important}
.map-float{position:absolute;left:12px;bottom:12px;z-index:1004;display:flex;flex-direction:column;gap:.6rem}
.float-btn{width:48px;height:48px;border-radius:50%;border:1px solid var(--line);background:#0f2a20;color:var(--text);display:flex;align-items:center;justify-content:center;box-shadow:var(--shadow);cursor:pointer}
.exit-fs{position:fixed;top:12px;right:12px;z-index:1100;display:none}
.exit-fs.show{display:block}

/* كروت النتائج */
.results{max-height:60vh;min-height:220px;overflow:auto;scrollbar-width:thin;scrollbar-color:#1e4a3a transparent}
.results::-webkit-scrollbar{width:7px}.results::-webkit-scrollbar-thumb{background:#1e4a3a;border-radius:3px}
.card-cafe{background:var(--card);border:1px solid var(--line);border-radius:14px;overflow:hidden;transition:transform .25s ease, box-shadow .25s ease}
.card-cafe:hover{transform:translateY(-4px);box-shadow:0 12px 28px rgba(0,0,0,.35)}
.avatar{width:52px;height:52px;border-radius:14px;background:#fff;border:1px solid #eaeaea;display:flex;align-items:center;justify-content:center;overflow:hidden}
.avatar img{width:100%;height:100%;object-fit:cover}.avatar .letter{font-weight:900;color:#222}
.chip{background:#103c2f;border:1px solid var(--line);padding:.25rem .55rem;border-radius:999px;font-size:.85rem;display:inline-flex;align-items:center;gap:.25rem}
.btn-route{background:linear-gradient(180deg,var(--mint),var(--mint2));color:#062016;border:0}

/* نجوم التقييم */
.star i{color:#ffc34d}

/* توست */
.toast-container{position:fixed;bottom:20px;right:20px;z-index:2100;display:flex;flex-direction:column;gap:10px}
.toast{background:#0f2a20;color:var(--text);border:1px solid var(--line);padding:12px 16px;border-radius:var(--radius);box-shadow:var(--shadow);display:flex;align-items:center;gap:10px}

/* لودر */
.loader{text-align:center;padding:2rem;display:none}
.coffee-loader{display:inline-block;position:relative;width:80px;height:80px}
.coffee-loader div{display:inline-block;position:absolute;left:8px;width:16px;background:var(--mint);animation:coffee 1.2s cubic-bezier(0,.5,.5,1) infinite;border-radius:20px}
.coffee-loader div:nth-child(1){left:8px;animation-delay:-.24s}.coffee-loader div:nth-child(2){left:32px;animation-delay:-.12s}.coffee-loader div:nth-child(3){left:56px}
@keyframes coffee{0%{top:8px;height:64px}50%,100%{top:24px;height:32px}}

/* ظهور بالتمرير */
.reveal{opacity:0;transform:translateY(12px);transition:opacity .5s ease, transform .5s ease}
.reveal.in-view{opacity:1;transform:translateY(0)}

/* تأثير بخار القهوة */
.coffee-steam {
  position: relative;
  display: inline-block;
  margin-left: 10px;
}
.steam {
  position: absolute;
  height: 15px;
  width: 15px;
  border-radius: 50%;
  background-color: rgba(255, 255, 255, 0.7);
  margin-top: -25px;
  margin-left: 5px;
  z-index: 0;
  opacity: 0;
}
.steam.one {
  -webkit-animation: steam-one 4s ease-out infinite;
  animation: steam-one 4s ease-out infinite;
}
.steam.two {
  -webkit-animation: steam-two 4s ease-out 0.5s infinite;
  animation: steam-two 4s ease-out 0.5s infinite;
}
.steam.three {
  -webkit-animation: steam-three 4s ease-out 1s infinite;
  animation: steam-three 4s ease-out 1s infinite;
}
@-webkit-keyframes steam-one {
  0% {transform: translateY(0) translateX(0) scale(0.25); opacity: 0.2;}
  100% {transform: translateY(-50px) translateX(-10px) scale(1); opacity: 0;}
}
@keyframes steam-one {
  0% {transform: translateY(0) translateX(0) scale(0.25); opacity: 0.2;}
  100% {transform: translateY(-50px) translateX(-10px) scale(1); opacity: 0;}
}
@-webkit-keyframes steam-two {
  0% {transform: translateY(0) translateX(0) scale(0.25); opacity: 0.2;}
  100% {transform: translateY(-45px) translateX(10px) scale(1); opacity: 0;}
}
@keyframes steam-two {
  0% {transform: translateY(0) translateX(0) scale(0.25); opacity: 0.2;}
  100% {transform: translateY(-45px) translateX(10px) scale(1); opacity: 0;}
}
@-webkit-keyframes steam-three {
  0% {transform: translateY(0) translateX(0) scale(0.25); opacity: 0.2;}
  100% {transform: translateY(-40px) translateX(-5px) scale(1); opacity: 0;}
}
@keyframes steam-three {
  0% {transform: translateY(0) translateX(0) scale(0.25); opacity: 0.2;}
  100% {transform: translateY(-40px) translateX(-5px) scale(1); opacity: 0;}
}

/* قائمة الإعدادات */
.settings-panel {
  position: fixed;
  top: 0;
  right: -350px;
  width: 350px;
  height: 100vh;
  background: var(--panel);
  border-left: 1px solid var(--line);
  z-index: 2000;
  padding: 20px;
  overflow-y: auto;
  transition: right 0.3s ease;
  box-shadow: -5px 0 15px rgba(0,0,0,0.2);
}
.settings-panel.open {
  right: 0;
}
.settings-toggle {
  position: fixed;
  top: 80px;
  right: 20px;
  z-index: 2001;
  width: 50px;
  height: 50px;
  border-radius: 50%;
  background: var(--mint);
  color: #062016;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: var(--shadow);
  border: 1px solid var(--line);
}

/* أزرار التحميل */
.download-buttons {
  position: fixed;
  bottom: 20px;
  left: 20px;
  z-index: 1000;
  display: flex;
  flex-direction: column;
  gap: 10px;
}
.download-btn {
  display: flex;
  align-items: center;
  gap: 10px;
  background: var(--panel);
  color: var(--text);
  border: 1px solid var(--line);
  padding: 10px 15px;
  border-radius: 30px;
  text-decoration: none;
  transition: all 0.3s ease;
  box-shadow: var(--shadow);
}
.download-btn:hover {
  transform: translateY(-3px);
  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

/* شات بوت */
.chatbot-container {
  position: fixed;
  bottom: 20px;
  right: 20px;
  z-index: 1000;
}
.chatbot-toggle {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  background: linear-gradient(180deg, var(--mint), var(--mint2));
  color: #062016;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  box-shadow: var(--shadow);
  border: none;
  font-size: 24px;
}
.chatbot-window {
  position: absolute;
  bottom: 70px;
  right: 0;
  width: 320px;
  height: 400px;
  background: var(--panel);
  border: 1px solid var(--line);
  border-radius: 15px;
  box-shadow: var(--shadow);
  display: none;
  flex-direction: column;
  overflow: hidden;
}
.chatbot-header {
  padding: 15px;
  background: var(--bg2);
  border-bottom: 1px solid var(--line);
  display: flex;
  justify-content: space-between;
  align-items: center;
}
.chatbot-messages {
  flex: 1;
  padding: 15px;
  overflow-y: auto;
}
.chatbot-input {
  padding: 15px;
  border-top: 1px solid var(--line);
  display: flex;
  gap: 10px;
}
.chatbot-input input {
  flex: 1;
  background: var(--input);
  border: 1px solid var(--line);
  border-radius: 20px;
  padding: 10px 15px;
  color: var(--text);
}

/* تجاوب */
@media (max-width:992px){
  .chip-input{flex-direction:column;gap:.5rem}.chip-input input{width:100%}
  .map-float{flex-direction:row;bottom:20px;left:50%;transform:translateX(-50%)}
  .float-btn{width:44px;height:44px}
  .exit-fs{top:auto;bottom:16px;left:50%;right:auto;transform:translateX(-50%)}
  .settings-panel {
    width: 300px;
  }
  .download-buttons {
    bottom: 80px;
    left: 10px;
  }
}
</style>
</head>
<body>
<div class="bg-stars" id="stars1"></div><div class="bg-stars bg-stars-2" id="stars2"></div>

<!-- إشعارات الصوت -->
<audio id="clickSound" src="https://assets.mixkit.co/sfx/preview/mixkit-select-click-1109.mp3" preload="auto"></audio>
<audio id="successSound" src="https://assets.mixkit.co/sfx/preview/mixkit-success-bell-901.mp3" preload="auto"></audio>
<audio id="errorSound" src="https://assets.mixkit.co/sfx/preview/mixkit-warning-alarm-buzzer-2851.mp3" preload="auto"></audio>

<header class="py-3">
  <div class="container d-flex align-items-center justify-content-between flex-wrap">
    <div class="brand"><i class="fa-solid fa-mug-saucer"></i> <span class="glow">كوفي فندر برو</span> <span class="ms-2 small text-success-50">السعودية</span>
      <div class="coffee-steam">
        <div class="steam one"></div>
        <div class="steam two"></div>
        <div class="steam three"></div>
      </div>
    </div>
    <div class="d-flex gap-2">
      <select id="radius" class="form-select form-select-sm bg-dark text-light border-secondary">
        <option value="2000">٢ كم</option><option value="5000">٥ كم</option><option value="10000" selected>١٠ كم</option>
        <option value="20000">٢٠ كم</option><option value="30000">٣٠ كم</option><option value="50000">٥٠ كم</option>
      </select>
      <select id="sort" class="form-select form-select-sm bg-dark text-light border-secondary">
        <option value="rating">حسب التقييم</option><option value="distance">حسب المسافة</option><option value="name">حسب الاسم</option><option value="hours">المفتوح أولاً</option>
      </select>
    </div>
  </div>
</header>

<main class="container my-3">
  <!-- لوحة البحث والفلاتر -->
  <section class="p-3 panel">
    <div class="row g-2 align-items-stretch position-relative">
      <div class="col-lg-9 position-relative">
        <div class="chip-input">
          <i class="fa-solid fa-magnifying-glass text-success"></i>
          <input id="query" placeholder="ابحث عن مدينة داخل السعودية (مثال: الرياض، جدة، الدمام، أبها)" aria-label="بحث">
          <button id="btnSearch" class="btn btn-mint"><i class="fa-solid fa-search me-1"></i>ابحث</button>
        </div>
        <div id="suggestions" class="suggest panel"></div>
      </div>
      <div class="col-lg-3 d-flex gap-2 flex-wrap">
        <div class="chip form-check"><input id="fOpen" class="form-check-input ms-1" type="checkbox"><label class="form-check-label" for="fOpen">مفتوح الآن</label></div>
        <div class="chip form-check"><input id="fWifi" class="form-check-input ms-1" type="checkbox"><label class="form-check-label" for="fWifi">واي فاي</label></div>
        <div class="chip form-check"><input id="fOutdoor" class="form-check-input ms-1" type="checkbox"><label class="form-check-label" for="fOutdoor">جلسات خارجية</label></div>
      </div>
    </div>

    <div class="mt-2 d-flex align-items-center gap-3 flex-wrap">
      <div class="d-flex align-items-center gap-2">
        <span class="small text-secondary">أقل تقييم</span>
        <input id="minRating" type="range" min="0" max="5" step="0.5" value="0"><span id="minRatingVal" class="small">0.0</span>
      </div>
      <div class="ms-auto small" id="kpi">جاهز</div>
    </div>
  </section>

  <!-- الخريطة + النتائج -->
  <section class="position-relative mt-3">
    <div class="row g-3">
      <div class="col-lg-8 position-relative">
        <div id="map" class="reveal"></div>
        <div class="map-float">
          <button id="btnFullscreen" class="float-btn" title="ملء الشاشة"><i class="fa-solid fa-maximize"></i></button>
          <button id="btnLayer" class="float-btn" title="تبديل الطبقة"><i class="fa-solid fa-layer-group"></i></button>
          <button id="btnSearchHere" class="float-btn" title="ابحث في هذه المنطقة"><i class="fa-solid fa-bullseye"></i></button>
          <button id="btnLocate" class="float-btn" title="موقعي"><i class="fa-solid fa-location-arrow"></i></button>
        </div>
      </div>
      <div class="col-lg-4">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <div class="h5 m-0"><i class="fa-solid fa-list me-2"></i>النتائج</div>
        </div>
        <div class="loader" id="loader"><div class="coffee-loader"><div></div><div></div><div></div></div><div class="mt-2">جاري البحث عن المقاهي…</div></div>
        <div id="results" class="results reveal"></div>
        <div id="nores" class="text-center text-secondary py-4 d-none">
          <i class="fa-regular fa-face-sad-tear fa-2x mb-2"></i><div>لا توجد نتائج هنا، جرّب منطقة أخرى.</div>
        </div>
      </div>
    </div>
  </section>
</main>

<footer class="py-4 mt-4">
  <div class="container small text-center">
    © <span id="yr"></span> كوفي فندر برو — السعودية · Tiles © OpenStreetMap · البيانات: Overpass/Photon/Nominatim
  </div>
</footer>

<!-- زر الخروج من ملء الشاشة -->
<div id="exitFS" class="exit-fs"><button class="btn btn-sm btn-mint" id="exitFsBtn"><i class="fa-solid fa-minimize me-1"></i>خروج</button></div>
<!-- توست -->
<div class="toast-container"></div>

<!-- إعدادات التطبيق -->
<button class="settings-toggle" id="settingsToggle"><i class="fas fa-cog"></i></button>
<div class="settings-panel" id="settingsPanel">
  <h4><i class="fas fa-sliders-h me-2"></i>إعدادات التطبيق</h4>
  
  <div class="mt-4">
    <h5>المظهر والموضوع</h5>
    <div class="d-flex gap-2 flex-wrap mt-3">
      <button class="btn btn-sm theme-btn" data-theme="default" style="background: var(--mint); color: #062016">افتراضي</button>
      <button class="btn btn-sm theme-btn" data-theme="coffee1" style="background: var(--coffee-theme-1); color: white">قهوة 1</button>
      <button class="btn btn-sm theme-btn" data-theme="coffee2" style="background: var(--coffee-theme-2); color: white">قهوة 2</button>
      <button class="btn btn-sm theme-btn" data-theme="coffee3" style="background: var(--coffee-theme-3); color: white">قهوة 3</button>
      <button class="btn btn-sm theme-btn" data-theme="coffee4" style="background: var(--coffee-theme-4); color: white">قهوة 4</button>
    </div>
  </div>
  
  <div class="mt-4">
    <h5>الأصوات</h5>
    <div class="form-check form-switch">
      <input class="form-check-input" type="checkbox" id="soundEffects" checked>
      <label class="form-check-label" for="soundEffects">تشغيل المؤثرات الصوتية</label>
    </div>
  </div>
  
  <div class="mt-4">
    <h5>اللغة</h5>
    <select class="form-select bg-dark text-light border-secondary" id="languageSelect">
      <option value="ar" selected>العربية</option>
      <option value="en">English</option>
      <option value="fr">Français</option>
      <option value="es">Español</option>
    </select>
  </div>
  
  <div class="mt-4">
    <h5>ميزات متقدمة</h5>
    <div class="form-check form-switch">
      <input class="form-check-input" type="checkbox" id="arMode">
      <label class="form-check-label" for="arMode">وضع الواقع المعزز (تجريبي)</label>
    </div>
    <div class="form-check form-switch">
      <input class="form-check-input" type="checkbox" id="aiRecommendations" checked>
      <label class="form-check-label" for="aiRecommendations">توصيات الذكاء الاصطناعي</label>
    </div>
    <div class="form-check form-switch">
      <input class="form-check-input" type="checkbox" id="vibrationFeedback">
      <label class="form-check-label" for="vibrationFeedback">الاهتزاز عند التفاعل</label>
    </div>
  </div>
</div>

<!-- أزرار التحميل -->
<div class="download-buttons">
  <a href="#" class="download-btn" id="downloadIOS">
    <i class="fab fa-apple fa-2x"></i>
    <div>
      <div class="small">حمّل على</div>
      <div>App Store</div>
    </div>
  </a>
  <a href="#" class="download-btn" id="downloadAndroid">
    <i class="fab fa-android fa-2x"></i>
    <div>
      <div class="small">حمّل على</div>
      <div>Google Play</div>
    </div>
  </a>
</div>

<!-- شات بوت -->
<div class="chatbot-container">
  <button class="chatbot-toggle" id="chatbotToggle"><i class="fas fa-robot"></i></button>
  <div class="chatbot-window" id="chatbotWindow">
    <div class="chatbot-header">
      <h5 class="m-0">مساعد القهوة</h5>
      <button class="btn btn-sm btn-close" id="closeChatbot"></button>
    </div>
    <div class="chatbot-messages" id="chatbotMessages">
      <div class="alert alert-info">
        مرحباً! أنا مساعدك للعثور على أفضل المقاهي. كيف يمكنني مساعدتك؟
      </div>
    </div>
    <div class="chatbot-input">
      <input type="text" id="chatbotInput" placeholder="اكتب رسالتك هنا...">
      <button class="btn btn-mint" id="sendMessage"><i class="fas fa-paper-plane"></i></button>
    </div>
  </div>
</div>

<!-- سكربتات -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>
<script>
// ... (الكود الأصلي مع إضافة الميزات الجديدة) ...

// وظائف إضافية للميزات الجديدة
function initAdvancedFeatures() {
  // إعدادات التطبيق
  const settingsToggle = document.getElementById('settingsToggle');
  const settingsPanel = document.getElementById('settingsPanel');
  
  settingsToggle.addEventListener('click', () => {
    settingsPanel.classList.toggle('open');
    playSound('click');
  });
  
  // تغيير الألوان
  const themeButtons = document.querySelectorAll('.theme-btn');
  themeButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const theme = btn.dataset.theme;
      changeTheme(theme);
      playSound('click');
    });
  });
  
  // الأصوات
  const soundEffects = document.getElementById('soundEffects');
  soundEffects.addEventListener('change', (e) => {
    localStorage.setItem('soundEnabled', e.target.checked);
  });
  
  // تحميل التطبيق
  const downloadIOS = document.getElementById('downloadIOS');
  const downloadAndroid = document.getElementById('downloadAndroid');
  
  downloadIOS.addEventListener('click', (e) => {
    e.preventDefault();
    alert('سيتم توفير التطبيق على متجر Apple قريباً');
    playSound('click');
  });
  
  downloadAndroid.addEventListener('click', (e) => {
    e.preventDefault();
    alert('سيتم توفير التطبيق على متجر Google Play قريباً');
    playSound('click');
  });
  
  // الشات بوت
  const chatbotToggle = document.getElementById('chatbotToggle');
  const chatbotWindow = document.getElementById('chatbotWindow');
  const closeChatbot = document.getElementById('closeChatbot');
  const sendMessage = document.getElementById('sendMessage');
  const chatbotInput = document.getElementById('chatbotInput');
  const chatbotMessages = document.getElementById('chatbotMessages');
  
  chatbotToggle.addEventListener('click', () => {
    chatbotWindow.style.display = chatbotWindow.style.display === 'flex' ? 'none' : 'flex';
    playSound('click');
  });
  
  closeChatbot.addEventListener('click', () => {
    chatbotWindow.style.display = 'none';
    playSound('click');
  });
  
  sendMessage.addEventListener('click', handleChatbotMessage);
  chatbotInput.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') handleChatbotMessage();
  });
  
  // الاهتزاز عند التفاعل
  document.addEventListener('click', (e) => {
    if (e.target.tagName === 'BUTTON' || e.target.tagName === 'A' || e.target.parentElement.tagName === 'BUTTON') {
      if (document.getElementById('vibrationFeedback').checked && navigator.vibrate) {
        navigator.vibrate(10);
      }
    }
  });
}

function changeTheme(theme) {
  const body = document.body;
  body.setAttribute('data-theme', theme);
  localStorage.setItem('theme', theme);
}

function playSound(type) {
  if (!document.getElementById('soundEffects').checked) return;
  
  const sound = document.getElementById(type + 'Sound');
  if (sound) {
    sound.currentTime = 0;
    sound.play().catch(e => console.log('لم يتم تشغيل الصوت:', e));
  }
}

function handleChatbotMessage() {
  const message = chatbotInput.value.trim();
  if (!message) return;
  
  // إضافة رسالة المستخدم
  addMessage(message, 'user');
  chatbotInput.value = '';
  
  // محاكاة رد المساعد
  setTimeout(() => {
    const response = generateChatbotResponse(message);
    addMessage(response, 'bot');
  }, 1000);
}

function addMessage(text, sender) {
  const messageDiv = document.createElement('div');
  messageDiv.className = `alert ${sender === 'user' ? 'alert-secondary' : 'alert-info'}`;
  messageDiv.innerHTML = text;
  chatbotMessages.appendChild(messageDiv);
  chatbotMessages.scrollTop = chatbotMessages.scrollHeight;
}

function generateChatbotResponse(message) {
  const lowerMessage = message.toLowerCase();
  
  if (lowerMessage.includes('مرحبا') || lowerMessage.includes('اهلا')) {
    return 'مرحباً! كيف يمكنني مساعدتك في العثور على أفضل المقاهي؟';
  } else if (lowerMessage.includes('قهوة') || lowerMessage.includes('مقهى')) {
    return 'أحب القهوة أيضاً! هل تبحث عن مقهى قريب منك؟';
  } else if (lowerMessage.includes('مساعدة') || lowerMessage.includes('مساعده')) {
    return 'يمكنني مساعدتك في:<br>1. العثور على مقاهي قريبة<br>2. معرفة آراء الآخرين<br>3. تصفية النتائج حسب تفضيلاتك<br>ما الذي تحتاج إليه؟';
  } else {
    return 'هذا سؤال مثير للاهتمام! للأسف أنا لا أزال أتعلم، لكن يمكنني مساعدتك في العثور على أفضل المقاهي في منطقتك.';
  }
}

// تهيئة الميزات المتقدمة عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', () => {
  initAdvancedFeatures();
  
  // تحميل الإعدادات المحفوظة
  const savedTheme = localStorage.getItem('theme') || 'default';
  changeTheme(savedTheme);
  
  const soundEnabled = localStorage.getItem('soundEnabled') !== 'false';
  document.getElementById('soundEffects').checked = soundEnabled;
});
</script>
</body>
</html>
